<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Teacher Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* (Use the same CSS styles as previous for consistency, specifically fonts and rtl) */
        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
        * { box-sizing: border-box; font-family: "Faruma", sans-serif; }
        body { background-color: #f0fdfa; margin: 0; padding: 20px; text-align: right; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        h1 { color: #0d9488; text-align: center; border-bottom: 2px solid #e0f2f1; padding-bottom: 10px; }
        .nav-menu { display: flex; gap: 10px; margin-bottom: 20px; background: #ccfbf1; padding: 10px; border-radius: 10px; overflow-x:auto;}
        .nav-btn { flex: 1; padding: 10px; border: none; background: white; border-radius: 8px; cursor: pointer; color: #0f766e; font-weight: bold; white-space: nowrap;}
        .nav-btn.active { background: #0d9488; color: white; }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        .card { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #fff; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        th { background: #0d9488; color: white; position:sticky; top:0;}
        tr:hover { background: #f9fafb; }

        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; text-align: center; margin: 2px 0; }
        .btn { padding: 10px; background: #0d9488; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top:5px;}
        .btn-red { background: #ef4444; }
        .btn-orange { background: #f97316; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
        .modal-content { background:white; margin:5% auto; padding:20px; width:90%; max-width:500px; border-radius:10px; }

        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    </style>
</head>
<body>

<div class="container">
    <h1>Admin Dashboard</h1>
    
    <div class="nav-menu">
        <button class="nav-btn active" onclick="switchTab('students')">üë®‚Äçüéì Students</button>
        <button class="nav-btn" onclick="switchTab('marks')">üìä Marks</button>
        <button class="nav-btn" onclick="switchTab('notice')">üì¢ Notice</button>
        <button class="nav-btn" onclick="location.reload()">üîí Logout</button>
    </div>

    <!-- 1. STUDENT MANAGER -->
    <div id="tab-students" class="section active">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn" style="flex:1" onclick="document.getElementById('modalAdd').style.display='block'">+ New Student</button>
            <button class="btn btn-orange" style="flex:1" onclick="document.getElementById('modalBulk').style.display='block'">üìó Excel Import</button>
        </div>
        <div style="overflow-x:auto;">
            <table id="studentTable">
                <thead><tr><th>Index</th><th>Name</th><th>Grade</th><th>Password</th><th>Action</th></tr></thead>
                <tbody><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- 2. MARKS ENTRY -->
    <div id="tab-marks" class="section">
        <div class="card" style="background:#f0fdfa;">
            <label>Select Item:</label>
            <select id="markItemSelect" onchange="renderMarksTable()">
                <option value="Week1">Week 1</option>
                <option value="Week2">Week 2</option>
                <option value="UnitTest1">Unit Test 1</option>
                <option value="CA1">CA 1</option>
            </select>
        </div>
        <div style="overflow-x:auto;">
            <table id="marksTable">
                <thead><tr><th>Index</th><th>Name</th><th>Mark / Status</th><th>Save</th></tr></thead>
                <tbody id="marksBody"></tbody>
            </table>
        </div>
    </div>

    <!-- 3. NOTICE MANAGER -->
    <div id="tab-notice" class="section">
        <div class="card">
            <h3>Update Notice Board</h3>
            <textarea id="adminNoticeText" rows="5" placeholder="Type notice here..."></textarea>
            <button class="btn" onclick="saveNotice()">Publish Notice</button>
        </div>
    </div>

</div>

<!-- MODAL: ADD STUDENT -->
<div id="modalAdd" class="modal">
    <div class="modal-content">
        <h3>Add Student</h3>
        <input id="newIdx" type="number" placeholder="Index">
        <input id="newNam" placeholder="Name">
        <input id="newGrd" placeholder="Grade">
        <input id="newCls" placeholder="Class">
        <input id="newPwd" placeholder="Password (Default 1234)" value="1234">
        <button class="btn" onclick="addSingleStudent()">Add</button>
        <button class="btn btn-red" onclick="this.parentElement.parentElement.style.display='none'">Cancel</button>
    </div>
</div>

<!-- MODAL: BULK IMPORT (FIXED) -->
<div id="modalBulk" class="modal">
    <div class="modal-content">
        <h3>Excel Import</h3>
        <p style="font-size:12px; color:#666;">Columns: <b>Index | Name | Grade | Class</b></p>
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <div id="bulkPreview" style="max-height:150px; overflow:auto; margin:10px 0; border:1px solid #eee;"></div>
        <button class="btn" onclick="processBulk()">Upload</button>
        <button class="btn btn-red" onclick="this.parentElement.parentElement.style.display='none'">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let students = [];
    let parsedData = [];

    // INIT
    fetchStudents();

    // NAVIGATION
    window.switchTab = (id) => {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(id === 'marks') renderMarksTable();
    };

    // FETCH LOGIC
    async function fetchStudents() {
        const snap = await getDocs(collection(db, "students"));
        students = [];
        snap.forEach(d => students.push({id: d.id, ...d.data()}));
        renderStudentTable();
    }

    // --- STUDENT MANAGER ---
    function renderStudentTable() {
        const tbody = document.querySelector('#studentTable tbody');
        tbody.innerHTML = students.map(s => `
            <tr>
                <td>${s.index}</td>
                <td>${s.name}</td>
                <td>${s.grade}${s.class}</td>
                <td>${s.password || '1234'}</td>
                <td><button style="background:red; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="delStudent('${s.id}')">X</button></td>
            </tr>
        `).join('');
    }

    window.addSingleStudent = async () => {
        const idx = document.getElementById('newIdx').value;
        const name = document.getElementById('newNam').value;
        if(!idx || !name) return alert("Required fields missing");

        // Check Duplicate
        if(students.some(s => String(s.index) === String(idx))) return alert("Index exists!");

        await setDoc(doc(collection(db, "students")), {
            index: idx, name: name, 
            grade: document.getElementById('newGrd').value,
            class: document.getElementById('newCls').value,
            password: document.getElementById('newPwd').value
        });
        alert("Added");
        document.getElementById('modalAdd').style.display='none';
        fetchStudents();
    };

    window.delStudent = async (id) => {
        if(confirm("Delete student?")) {
            await deleteDoc(doc(db, "students", id));
            fetchStudents();
        }
    };

    // --- BULK UPLOAD (FIXED DATA LOSS ISSUE) ---
    document.getElementById('excelFile').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            
            parsedData = [];
            json.forEach((row, i) => {
                // Ensure row has index and name, skip header if it says 'Index'
                if(row.length >= 2 && row[0] !== 'Index') {
                    parsedData.push({
                        index: String(row[0]), 
                        name: String(row[1]), 
                        grade: String(row[2]||''), 
                        class: String(row[3]||'')
                    });
                }
            });
            document.getElementById('bulkPreview').innerText = `Found ${parsedData.length} students. Ready to upload.`;
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    window.processBulk = async () => {
        if(parsedData.length === 0) return alert("No data");
        let count = 0;
        
        for(let s of parsedData) {
            // CRITICAL FIX: Check if index exists in current list
            const exists = students.some(cur => String(cur.index) === String(s.index));
            
            if(!exists) {
                // Only ADD if not exists. Do NOT overwrite.
                await setDoc(doc(collection(db, "students")), {
                    index: s.index, name: s.name, grade: s.grade, class: s.class, password: "1234"
                });
                count++;
            }
        }
        alert(`Uploaded ${count} new students. (Duplicates skipped)`);
        document.getElementById('modalBulk').style.display='none';
        fetchStudents();
    };

    // --- MARKS MANAGER ---
    window.renderMarksTable = () => {
        const item = document.getElementById('markItemSelect').value;
        const tbody = document.getElementById('marksBody');
        tbody.innerHTML = students.map(s => `
            <tr>
                <td>${s.index}</td>
                <td>${s.name}</td>
                <td><input class="mark-in" id="m_${s.id}" value="${s[item] || ''}" placeholder="-"></td>
                <td><button onclick="saveMark('${s.id}')">üíæ</button></td>
            </tr>
        `).join('');
    };

    window.saveMark = async (id) => {
        const item = document.getElementById('markItemSelect').value;
        const val = document.getElementById(`m_${id}`).value;
        await updateDoc(doc(db, "students", id), { [item]: val });
        // Optional: Auto badge logic here (e.g., if val > 90 add badge)
    };

    // --- NOTICE MANAGER ---
    window.saveNotice = async () => {
        const txt = document.getElementById('adminNoticeText').value;
        await setDoc(doc(db, "settings", "notice"), { text: txt });
        alert("Notice Updated");
    };

    // Make functions global
    window.delStudent = delStudent; window.saveMark = saveMark;
</script>
</body>
</html>
