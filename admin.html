<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Admin Panel</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    /* --- FONTS & RESETS --- */
    @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
    
    :root {
        --primary: #10b981;       /* Modern Emerald Green */
        --primary-dark: #059669;  /* Darker Green for hover */
        --accent: #f59e0b;        /* Amber for actions */
        --danger: #ef4444;        /* Red for delete/fail */
        --bg-body: #ecfdf5;       /* Very light mint background */
        --bg-card: #ffffff;
        --text-main: #1f2937;
        --text-light: #6b7280;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 12px;
    }

    * { box-sizing: border-box; font-family: "Faruma", sans-serif; }

    body {
        background-color: var(--bg-body);
        margin: 0;
        padding: 20px 10px;
        text-align: right;
        color: var(--text-main);
        line-height: 1.6;
    }

    /* --- LAYOUT --- */
    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--bg-card);
        padding: 30px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        position: relative;
        min-height: 85vh;
        border-top: 5px solid var(--primary);
    }

    h1 {
        color: var(--primary-dark);
        text-align: center;
        margin-bottom: 30px;
        font-size: 2rem;
        border-bottom: 2px dashed #a7f3d0;
        padding-bottom: 15px;
    }

    /* --- CARDS --- */
    .card {
        background: #fff;
        padding: 25px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
        box-shadow: var(--shadow);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    .card-highlight {
        background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
        border: 1px solid #10b981;
        text-align: center;
    }

    /* --- INPUTS & FORMS --- */
    input, select, textarea {
        width: 100%;
        padding: 12px 15px;
        margin: 8px 0;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        text-align: center;
        outline: none;
        transition: 0.3s;
        background: #f9fafb;
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    /* --- BUTTONS --- */
    .btn {
        width: 100%;
        padding: 12px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
        margin-top: 10px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }

    .btn-mat { background: linear-gradient(45deg, #f59e0b, #d97706); }
    .btn-add { width: auto; padding: 8px 16px; background: #3b82f6; font-size: 13px; }
    .btn-save { position: fixed; bottom: 30px; right: 20px; left: 20px; width: calc(100% - 40px); z-index: 100; max-width: 960px; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .btn-del { width:auto; padding: 5px 10px; background: #ef4444; font-size: 12px; border-radius: 4px; }
    .btn-edit { background: #f59e0b; padding: 5px 10px; border-radius: 4px; width: auto; }

    /* --- TABLES --- */
    .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
        border-radius: var(--radius);
        border: 1px solid #e5e7eb;
        background: white;
    }

    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    
    th {
        background: #065f46;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: normal;
        position: sticky;
        top: 0;
    }

    td { padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center; font-size: 14px; }
    tr:nth-child(even) { background-color: #f9fafb; }
    tr:hover { background-color: #f0fdf4; }

    /* --- TEACHER INPUTS IN TABLE --- */
    .v-in {
        border: 1px solid #d1d5db !important;
        background: white !important;
        font-weight: bold;
        color: #374151;
        border-radius: 6px;
        box-shadow: none;
    }
    .v-in:focus { border-color: var(--primary) !important; }

    /* --- PILLS & FILTERS --- */
    .pills { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; scrollbar-width: none; }
    .pill {
        padding: 8px 18px;
        background: #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        white-space: nowrap;
        font-size: 13px;
        color: #4b5563;
        font-weight: bold;
        transition: 0.3s;
        border: 1px solid transparent;
    }
    .pill:hover { background: #d1d5db; }
    .pill.active { background: var(--primary); color: white; border-color: var(--primary-dark); box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }

    /* --- PARENT RESULT VIEW --- */
    .result-header {
        background: linear-gradient(to right, #065f46, #10b981);
        color: white;
        padding: 25px;
        border-radius: var(--radius) var(--radius) 0 0;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .result-section { margin-bottom: 30px; }
    .result-title { 
        font-size: 18px; font-weight: bold; color: var(--primary-dark); 
        border-bottom: 2px solid #a7f3d0; padding-bottom: 8px; margin-bottom: 15px; 
    }

    .result-item {
        display: flex; justify-content: space-between; align-items: center;
        background: white; border: 1px solid #e5e7eb;
        padding: 15px; margin-bottom: 10px; border-radius: 10px;
        border-right: 5px solid #d1d5db;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .result-item.done { border-right-color: #10b981; background: #ecfdf5; }
    .result-item.pending { border-right-color: #f59e0b; background: #fffbeb; }
    .result-item.incomplete { border-right-color: #ef4444; background: #fef2f2; }

    .score-circle {
        width: 40px; height: 40px;
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- MODALS --- */
    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
        animation: fadeIn 0.3s;
    }
    
    .modal-content {
        background-color: #fff; margin: 5% auto; padding: 30px;
        border-radius: 20px; width: 90%; max-width: 500px;
        text-align: center; max-height: 85vh; overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-top: 5px solid var(--primary);
    }

    /* --- UTILS --- */
    .drop-zone { border: 2px dashed #9ca3af; padding: 30px; border-radius: 10px; background: #f9fafb; cursor: pointer; transition: 0.3s; }
    .drop-zone:hover { border-color: var(--primary); background: #ecfdf5; }
    
    .admin-trigger { position: absolute; top: 0; left: 0; width: 60px; height: 60px; z-index: 200; cursor: default; opacity: 0; }
    .admin-input-group { display: none; position: absolute; top: 50px; left: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1001; border: 1px solid #eee; }

    .grade-badge { padding: 4px 10px; border-radius: 6px; color: white; font-size: 12px; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .g-A-star { background: #f59e0b; color:black; } .g-A { background: #10b981; } .g-B { background: #3b82f6; } .g-C { background: #f97316; } .g-Fail { background: #ef4444; }

    .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    #toast { 
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); 
        background: #1f2937; color: white; padding: 12px 24px; 
        border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; 
        pointer-events: none; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
    }

    @media (min-width: 768px) {
        .btn-save { width: auto; right: 40px; left: auto; padding: 15px 40px; }
    }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:#00796b; margin-top:0;">Teacher Login</h2>
        <input type="password" id="adminPass" class="mini-input" placeholder="Password">
        <button onclick="checkLogin()" class="btn">Login</button>
    </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
    <h1>Admin / Teacher Panel</h1>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:white; padding:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
        <div style="font-weight:bold; color:#00796b;">Dashboard</div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-add" style="background:#43a047;" onclick="openStudentModal()" title="Add Single Student">+1</button>
            <button class="btn btn-add" style="background:#00897b;" onclick="openBulkModal()" title="Import from Excel">Excel üìó</button>
            <button class="btn btn-add" style="background:#f57c00;" onclick="openMatManager()" title="Manage Files">File üìÇ</button>
        </div>
    </div>
    
    <div class="card">
        <div class="pills">
            <div class="pill active" id="m_work" onclick="setMode('work')">Work (Weekly)</div>
            <div class="pill" id="m_test" onclick="setMode('test')">Unit Tests</div>
            <div class="pill" id="m_ca" onclick="setMode('ca')">CA / Exams</div>
        </div>
        
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:15px;">
            <div style="flex:1; min-width:150px;">
                <small style="color:#666; font-weight:bold;">Select Item:</small>
                <div style="display:flex; gap:5px;">
                    <select id="itemSelect" onchange="renderTeacherTable()"></select>
                    <button class="btn btn-add" style="background:#00695c; padding:0 12px; font-size:18px;" onclick="openResultModal()" title="Upload Marks">üì§</button>
                </div>
            </div>
            
            <div id="totalDiv" style="width:130px; display:none; flex-direction:column;">
                <small style="color:#666; font-weight:bold;">Total Marks:</small>
                <div style="display:flex; gap:2px;">
                    <input type="number" id="totalMarks" value="20" style="padding:5px; height:35px;">
                    <button onclick="saveTotalMark()" style="background:#2e7d32; border:none; color:white; border-radius:4px; cursor:pointer; width:35px;" title="Save Total">üíæ</button>
                </div>
            </div>
        </div>
        
        <div style="margin-top:15px;">
            <small style="color:#666; font-weight:bold;">Filter Students:</small>
            <div id="gradeFilter" class="pills" style="margin-bottom:5px;"></div>
            <div id="classFilter" class="pills"></div>
        </div>
        
        <div style="text-align:right; margin-top:10px;">
                <button onclick="fetchData()" style="background:none; border:none; color:#00695c; font-size:13px; cursor:pointer; text-decoration:underline;">üîÑ Refresh Data</button>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width:50px;">Idx</th>
                    <th style="text-align:right;">Name</th>
                    <th id="valHead" style="width:100px;">Status/Mark</th>
                    <th id="thG" style="display:none; width:50px;">%</th>
                    <th>Note</th>
                    <th style="width:40px;">Msg</th>
                    <th style="width:50px;">Act</th>
                </tr>
            </thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
    
    <button class="btn btn-save" id="sBtn" onclick="saveTeacherData()">üíæ Save Changes</button>
    <div style="height:80px;"></div>
</div>

<!-- ALL ADMIN MODALS -->
<div id="studentModal" class="modal"><div class="modal-content"><h3>Add Student</h3><input type="number" id="newStIndex" placeholder="Index"><input type="text" id="newStName" placeholder="Name"><div style="display:flex;gap:5px"><input id="newStGrade" placeholder="Grade"><input id="newStClass" placeholder="Class"></div><button class="btn btn-add" onclick="addNewStudent()">Save</button><button class="btn" style="background:#ccc;margin-top:5px" onclick="closeModal('studentModal')">Cancel</button></div></div>

<div id="editStudentModal" class="modal"><div class="modal-content"><h3 style="color:#f57c00">Edit Student</h3><input type="hidden" id="editStId"><input id="editStIndex" placeholder="Index"><input id="editStName" placeholder="Name"><div style="display:flex;gap:5px"><input id="editStGrade" placeholder="Grade"><input id="editStClass" placeholder="Class"></div><button class="btn btn-add" onclick="saveEditStudent()">Update</button><hr><button class="btn" style="background:#c62828" onclick="deleteStudent()">Delete Student</button><button class="btn" style="background:#ccc;margin-top:5px" onclick="closeModal('editStudentModal')">Cancel</button></div></div>

<div id="bulkModal" class="modal"><div class="modal-content"><h3>Excel Import</h3><label for="excelFile" class="drop-zone">üìÇ Upload Student List</label><input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none"><div id="previewArea" style="display:none"><div id="excelPreview"></div><button class="btn btn-add" id="btnConfirmBulk" onclick="confirmExcelUpload()">Confirm</button></div><button class="btn" style="background:#ccc;margin-top:5px" onclick="closeModal('bulkModal');resetBulk()">Cancel</button></div></div>

<div id="resultModal" class="modal"><div class="modal-content"><h3>Upload Marks</h3><p id="resultTargetName"></p><label for="resExcelFile" class="drop-zone">üìä Upload Marks Excel</label><input type="file" id="resExcelFile" accept=".xlsx,.xls" style="display:none"><div id="resPreviewArea" style="display:none"><div id="resExcelPreview"></div><button class="btn btn-add" id="btnConfirmRes" onclick="confirmResultUpload()">Upload</button></div><button class="btn" style="background:#ccc;margin-top:5px" onclick="closeModal('resultModal');resetResBulk()">Cancel</button></div></div>

<div id="matManagerModal" class="modal"><div class="modal-content"><h3>Materials</h3><input id="newMatTitle" placeholder="Title"><input id="newMatLink" placeholder="Link"><button class="btn btn-add" onclick="addMaterial()">Add</button><hr><div id="matListTeacher" style="text-align:left;max-height:300px;overflow:auto"></div><button class="btn" style="background:#ccc;margin-top:5px" onclick="closeModal('matManagerModal')">Close</button></div></div>

<div id="msgModal" class="modal"><div class="modal-content"><h3>Parent Message</h3><div id="msgContent" style="text-align:right;background:#f1f8e9;padding:10px;margin-bottom:10px"></div><button class="btn" style="background:#ccc" onclick="closeModal('msgModal')">Close</button></div></div>

<div id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSEHqUQIegVjhWKpRgpJybdPaVDVroVos",
      authDomain: "islam-portal-muthamin.firebaseapp.com",
      projectId: "islam-portal-muthamin",
      storageBucket: "islam-portal-muthamin.firebasestorage.app",
      messagingSenderId: "842342714257",
      appId: "1:842342714257:web:c5daa61eee6524e7936830"
    };

    let db;
    let students = [];
    let materials = [];
    let examConfig = {};
    let mode = 'work';
    let selGrade = 'All';
    let selClass = 'All';
    let parsedExcelData = [];
    let parsedResultData = [];

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    // LOGIN
    window.checkLogin = () => {
        if(document.getElementById('adminPass').value === "123") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            fetchData();
        } else { alert("Wrong Password"); }
    }

    // DATA
    window.fetchData = async () => {
        document.getElementById('tBody').innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
        try {
            const sSnap = await getDocs(collection(db, "students"));
            students = []; sSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
            const mSnap = await getDocs(collection(db, "materials"));
            materials = []; mSnap.forEach(doc => materials.push({ id: doc.id, ...doc.data() }));
            try { const c = await getDoc(doc(db, "settings", "examConfig")); if(c.exists()) examConfig = c.data(); } catch(e){}
            updateFilters(); setMode(mode);
        } catch(e) { alert("Error loading data"); }
    };

    // LOGIC
    window.setMode = (m) => {
        mode = m;
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        document.getElementById('m_'+m).classList.add('active');
        let sel = document.getElementById('itemSelect'); sel.innerHTML = "";
        if(m=='work') {
            for(let i=1;i<=45;i++) sel.innerHTML += `<option value="Week${i}">Week ${i}</option>`;
            document.getElementById('totalDiv').style.display = 'none'; document.getElementById('thG').style.display = 'none'; document.getElementById('valHead').innerText = 'Status';
        } else {
            document.getElementById('totalDiv').style.display = 'flex'; document.getElementById('thG').style.display = 'table-cell'; document.getElementById('valHead').innerText = 'Marks';
            let prefix = m=='test' ? 'UnitTest' : 'CA'; let count = m=='test' ? 10 : 4;
            for(let i=1;i<=count;i++) sel.innerHTML += `<option value="${prefix}${i}">${m=='test'?'Unit Test':'CA'} ${i}</option>`;
        }
        renderTeacherTable();
    };

    window.saveTotalMark = async () => {
        const item = document.getElementById('itemSelect').value; const val = document.getElementById('totalMarks').value;
        if(item && val) { await setDoc(doc(db, "settings", "examConfig"), { [item]: val }, { merge: true }); examConfig[item] = val; showToast("Saved"); renderTeacherTable(); }
    };

    window.renderTeacherTable = () => {
        const item = document.getElementById('itemSelect').value;
        let def = mode === 'test' ? 20 : 100;
        let tot = examConfig[item] ? parseInt(examConfig[item]) : def;
        if(mode !== 'work') document.getElementById('totalMarks').value = tot;

        let filtered = students;
        if(selGrade !== 'All') filtered = filtered.filter(s => String(s.grade) === String(selGrade));
        if(selClass !== 'All') filtered = filtered.filter(s => String(s.class) === String(selClass));

        let html = "";
        filtered.sort((a,b) => (parseInt(a.index)||0) - (parseInt(b.index)||0)).forEach(s => {
            let val = s[item] || ""; let note = s[item + "_note"] || ""; let hasMsg = s.parentMessages && s.parentMessages.length > 0;
            let input = mode === 'work' ? 
                `<select class="v-in" data-id="${s.id}" data-orig="${val}"><option value="">-</option><option value="ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®" ${val=='ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®'?'selected':''}>ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®</option><option value="ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠" ${val=='ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠'?'selected':''}>ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</option><option value="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠" ${val=='ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠'?'selected':''}>ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ™ﬁàﬁ≠</option></select>` : 
                `<input type="number" class="v-in" data-id="${s.id}" data-orig="${val}" value="${val}" placeholder="0" oninput="updRow(this, ${tot})">`;
            let gradeHtml = mode !== 'work' && val ? calcGradeHtml(val, tot) : '';
            let msgBtn = hasMsg ? `<button onclick='viewMessages(${JSON.stringify(s.parentMessages)})' style="border:none;background:#ffeb3b;border-radius:50%;width:25px;height:25px;cursor:pointer">üì©</button>` : `-`;
            
            html += `<tr><td><b>${s.index}</b></td><td style="text-align:right">${s.name}<br><small style="color:#888">${s.grade}${s.class}</small></td><td>${input} <div id="g-${s.id}" style="margin-top:2px">${gradeHtml}</div></td>${mode!='work' ? `<td><small id="p-${s.id}">${val ? Math.round((val/tot)*100)+'%' : ''}</small></td>` : ''}<td><input type="text" class="n-in" data-id="${s.id}" data-orig-note="${note}" value="${note}"></td><td>${msgBtn}</td><td><button class="btn-edit" onclick="openEdit('${s.id}')">‚úèÔ∏è</button></td></tr>`;
        });
        document.getElementById('tBody').innerHTML = html || "<tr><td colspan='7'>No Data</td></tr>";
    };

    window.saveTeacherData = async () => {
        const item = document.getElementById('itemSelect').value; const inputs = document.querySelectorAll('.v-in');
        let batchPromises = []; let count = 0; document.getElementById('sBtn').innerText = "Saving...";
        inputs.forEach(inp => {
            let id = inp.dataset.id; let val = inp.value; let note = document.querySelector(`.n-in[data-id="${id}"]`).value;
            if(val !== inp.dataset.orig || note !== document.querySelector(`.n-in[data-id="${id}"]`).dataset.origNote) {
                batchPromises.push(updateDoc(doc(db, "students", id), { [item]: val, [item+"_note"]: note })); count++;
            }
        });
        await Promise.all(batchPromises); showToast(`Saved ${count}`); document.getElementById('sBtn').innerText = "üíæ Save Changes"; fetchData(false);
    };

    // STUDENT MANAGEMENT
    window.openStudentModal = () => document.getElementById('studentModal').style.display='block';
    window.addNewStudent = async () => {
        let idx=document.getElementById('newStIndex').value; let name=document.getElementById('newStName').value;
        if(idx && name) { await addDoc(collection(db,"students"),{index:idx,name:name,grade:document.getElementById('newStGrade').value,class:document.getElementById('newStClass').value}); fetchData(); closeModal('studentModal'); }
    };
    window.openEdit = (id) => {
        let s = students.find(x=>x.id===id); if(s){ 
            document.getElementById('editStId').value=s.id; document.getElementById('editStIndex').value=s.index;
            document.getElementById('editStName').value=s.name; document.getElementById('editStGrade').value=s.grade;
            document.getElementById('editStClass').value=s.class; document.getElementById('editStudentModal').style.display='block';
        }
    };
    window.saveEditStudent = async () => {
        let id=document.getElementById('editStId').value;
        if(id) { await updateDoc(doc(db,"students",id),{index:document.getElementById('editStIndex').value, name:document.getElementById('editStName').value, grade:document.getElementById('editStGrade').value, class:document.getElementById('editStClass').value}); fetchData(); closeModal('editStudentModal'); }
    };
    window.deleteStudent = async () => {
        let id=document.getElementById('editStId').value;
        if(confirm("Delete?")) { await deleteDoc(doc(db,"students",id)); fetchData(); closeModal('editStudentModal'); }
    };

    // MATERIAL MANAGEMENT
    window.openMatManager = () => { document.getElementById('matManagerModal').style.display='block'; renderMat(); };
    window.addMaterial = async () => { let t=document.getElementById('newMatTitle').value; let l=document.getElementById('newMatLink').value; if(t&&l){await addDoc(collection(db,"materials"),{title:t,link:l}); renderMat();} };
    window.removeMaterial = async (id) => { await deleteDoc(doc(db,"materials",id)); renderMat(); };
    function renderMat() { document.getElementById('matListTeacher').innerHTML = materials.map(m=>`<div class="mat-item"><span>${m.title}</span><button class="btn-del" onclick="removeMaterial('${m.id}')">Del</button></div>`).join(''); }

    // BULK IMPORT & RESULT IMPORT (Shortened for brevity but functional)
    document.getElementById('excelFile').addEventListener('change', e=>{const r=new FileReader();r.onload=e=>{const j=XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result),{type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result),{type:'array'}).SheetNames[0]],{header:1}); parsedExcelData=[]; let h='<table>'; j.forEach((r,i)=>{if(r.length>=2&&(i>0||!isNaN(r[0]))){parsedExcelData.push({index:r[0],name:r[1],grade:r[2],class:r[3]}); if(parsedExcelData.length<=5)h+=`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`;}}); document.getElementById('excelPreview').innerHTML=h+"</table>"; document.getElementById('previewArea').style.display='block';};r.readAsArrayBuffer(e.target.files[0]);});
    window.confirmExcelUpload = async () => { let p=[]; parsedExcelData.forEach(s=>{if(!students.some(x=>String(x.index)==String(s.index))) p.push(addDoc(collection(db,"students"),{index:String(s.index),name:String(s.name),grade:String(s.grade||''),class:String(s.class||'')}));}); await Promise.all(p); fetchData(); closeModal('bulkModal'); showToast("Uploaded"); };
    
    document.getElementById('resExcelFile').addEventListener('change', e=>{const r=new FileReader();r.onload=e=>{const j=XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result),{type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result),{type:'array'}).SheetNames[0]],{header:1}); parsedResultData=[]; let h='<table>'; j.forEach((r,i)=>{if(r.length>=2&&(i>0||!isNaN(r[0]))){parsedResultData.push({index:r[0],mark:r[1]}); if(parsedResultData.length<=5)h+=`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`;}}); document.getElementById('resExcelPreview').innerHTML=h+"</table>"; document.getElementById('resPreviewArea').style.display='block';};r.readAsArrayBuffer(e.target.files[0]);});
    window.confirmResultUpload = async () => { let item=document.getElementById('itemSelect').value; let p=[]; parsedResultData.forEach(r=>{let s=students.find(x=>String(x.index)==String(r.index)); if(s) p.push(updateDoc(doc(db,"students",s.id),{[item]:String(r.mark)}));}); await Promise.all(p); fetchData(); closeModal('resultModal'); showToast("Uploaded"); };

    // UTILS
    window.setGradeFilter = (g) => { selGrade=g; selClass='All'; updateFilters(); renderTeacherTable(); };
    window.setClassFilter = (c) => { selClass=c; updateFilters(); renderTeacherTable(); };
    window.updateFilters = () => {
        const gs = [...new Set(students.map(s => s.grade))].filter(Boolean).sort();
        document.getElementById('gradeFilter').innerHTML = `<div class="pill ${selGrade=='All'?'active':''}" onclick="setGradeFilter('All')">All</div>` + gs.map(g=>`<div class="pill ${selGrade==g?'active':''}" onclick="setGradeFilter('${g}')">Gr ${g}</div>`).join('');
        if(selGrade !== 'All') {
             const cs = [...new Set(students.filter(s=>s.grade==selGrade).map(s=>s.class))].filter(Boolean).sort();
             document.getElementById('classFilter').innerHTML = `<div class="pill ${selClass=='All'?'active':''}" onclick="setClassFilter('All')">All</div>` + cs.map(c=>`<div class="pill ${selClass==c?'active':''}" onclick="setClassFilter('${c}')">${c}</div>`).join('');
        } else { document.getElementById('classFilter').innerHTML = ""; }
    };
    window.calcGradeHtml = (v,t) => { let p=(v/t)*100; let c='',l='F'; if(p>=90){c='g-A-star';l='A*'}else if(p>=80){c='g-A';l='A'}else if(p>=70){c='g-B';l='B'}else if(p>=60){c='g-C';l='C'}else{c='g-Fail';l='F'} return `<span class="grade-badge ${c}">${l}</span>`; };
    window.updRow = (el,t) => { document.getElementById('g-'+el.dataset.id).innerHTML = calcGradeHtml(el.value,t); };
    window.viewMessages = (m) => { if(!m||!m.length)return; let l=m[m.length-1]; document.getElementById('msgContent').innerHTML=`<small>${l.date}</small><br><p>"${l.text}"</p>`; document.getElementById('msgModal').style.display='block'; };
    window.openBulkModal=()=>document.getElementById('bulkModal').style.display='block'; window.openResultModal=()=>document.getElementById('resultModal').style.display='block'; window.closeModal=(i)=>document.getElementById(i).style.display='none'; window.resetBulk=()=>{document.getElementById('excelFile').value='';document.getElementById('previewArea').style.display='none'}; window.resetResBulk=()=>{document.getElementById('resExcelFile').value='';document.getElementById('resPreviewArea').style.display='none'};
    function showToast(m){let t=document.getElementById('toast');t.innerText=m;t.style.opacity=1;t.style.bottom='80px';setTimeout(()=>t.style.opacity=0,3000);}
</script>
</body>
</html>
