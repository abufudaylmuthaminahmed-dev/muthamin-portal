<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞ - ﬁêﬁ∞ﬁìﬁ´ﬁëﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ ﬁëﬁ≠ﬁùﬁ∞ﬁÑﬁØﬁëﬁ∞</title>
    <style>
        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
        * { font-family: "Faruma", sans-serif; box-sizing: border-box; }
        
        :root {
            --primary: #0d9488; /* Teal */
            --secondary: #f0fdfa;
            --accent: #f59e0b; /* Gold for badges */
            --text: #134e4a;
            --bg: #f3f4f6;
        }

        body { background-color: var(--bg); margin: 0; padding: 10px; text-align: right; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; min-height: 90vh; padding-bottom: 60px; }

        /* HEADER & NOTICE BOARD */
        .header { text-align: center; margin-bottom: 20px; }
        .notice-board { 
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
            padding: 15px; border-radius: 15px; margin-bottom: 20px;
            border: 2px solid #5eead4; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            animation: slideDown 0.5s;
        }
        .notice-title { font-weight: bold; color: #0f766e; margin-bottom: 5px; display:flex; align-items:center; gap:5px;}

        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: var(--primary); border-bottom: 2px solid #e0e0e0; padding-bottom: 5px; }

        /* GAMIFICATION BADGES */
        .badges-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .badge { 
            background: #fffbeb; border: 1px solid #fcd34d; border-radius: 50%; 
            width: 60px; height: 60px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; font-size: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); opacity: 0.5; filter: grayscale(100%);
        }
        .badge.earned { opacity: 1; filter: grayscale(0%); transform: scale(1.1); border-color: var(--accent); background: #fff7ed; }
        .badge-label { font-size: 8px; margin-top: 2px; text-align:center; line-height:1;}

        /* WEEKLY WORK & SUBMISSION */
        .work-item { background: #f9fafb; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-right: 4px solid #ccc; display:flex; justify-content:space-between; align-items:center;}
        .work-item.done { border-right-color: var(--primary); background: #f0fdfa; }
        
        .upload-btn { 
            background: #e0f2f1; color: #00695c; border: 2px dashed #009688; 
            padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; text-align: center;
        }
        
        /* CHAT / ASK TEACHER */
        .chat-box { background: #f1f5f9; padding: 10px; border-radius: 10px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
        .msg { padding: 8px; border-radius: 8px; margin-bottom: 5px; font-size: 13px; width: fit-content; max-width: 80%; }
        .msg.student { background: #d1fae5; margin-right: auto; text-align: right; }
        .msg.teacher { background: #white; border: 1px solid #ddd; margin-left: auto; text-align: right; }

        /* INPUTS & BUTTONS */
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; text-align: right; font-family: inherit;}
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-logout { background: #ef4444; margin-top: 20px; }

        /* LOGIN SCREEN */
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #ccfbf1; z-index: 1000; display:flex; align-items:center; justify-content:center; flex-direction:column; padding:20px;}
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        
        .role-switch { display: flex; background: #eee; padding: 5px; border-radius: 10px; margin-bottom: 15px; }
        .role-btn { flex: 1; padding: 8px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .role-btn.active { background: white; shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); }

        @keyframes slideDown { from {transform: translateY(-20px); opacity:0;} to {transform: translateY(0); opacity:1;} }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-top:0;">ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h2>
        
        <div class="role-switch">
            <button class="role-btn active" id="btnRoleStudent" onclick="setRole('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™</button>
            <button class="role-btn" id="btnRoleParent" onclick="setRole('parent')">ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß</button>
        </div>

        <input type="number" id="idx" placeholder="ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™">
        <input type="password" id="pass" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
        <button class="btn" onclick="login()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        <p style="font-size:12px; color:#666; margin-top:10px; cursor:pointer;" onclick="alert('ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ¶ﬁÅﬁ∞ ﬁéﬁ™ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁß!')">ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ¶ﬁÇﬁãﬁßﬁÇﬁ∞ﬁÇﬁ¨ﬁåﬁ™ﬁÇﬁ©ÿü</p>
    </div>
</div>

<!-- MAIN DASHBOARD -->
<div class="container" id="dashboard" style="display:none;">
    
    <div class="header">
        <h2 style="margin:0;" id="stName">Student Name</h2>
        <small id="stClass">Grade 10A | Index: 1001</small>
    </div>

    <!-- 1. NOTICE BOARD -->
    <div class="notice-board">
        <div class="notice-title">üì¢ ﬁáﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÇﬁ∞</div>
        <p id="noticeText" style="margin:0; font-size:14px;">ﬁâﬁ® ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¶ﬁáﬁ® ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁáﬁ¨ﬁêﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ¨ﬁáﬁ∞ ﬁáﬁÆﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨.</p>
    </div>

    <!-- 2. GAMIFICATION (BADGES) -->
    <div class="card">
        <div class="section-title">üèÜ ﬁÜﬁßﬁâﬁ®ﬁîﬁßﬁÑﬁ©ﬁåﬁ¶ﬁáﬁ∞</div>
        <div class="badges-container">
            <div class="badge" id="badge-homework"><span style="font-size:24px;">üìù</span><span class="badge-label">Homework Hero</span></div>
            <div class="badge" id="badge-fullmarks"><span style="font-size:24px;">‚≠ê</span><span class="badge-label">Star Student</span></div>
            <div class="badge" id="badge-active"><span style="font-size:24px;">üî•</span><span class="badge-label">Active</span></div>
            <div class="badge" id="badge-punctual"><span style="font-size:24px;">‚è∞</span><span class="badge-label">On Time</span></div>
        </div>
    </div>

    <!-- 3. PROGRESS & MARKS -->
    <div class="card">
        <div class="section-title">üìä ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß</div>
        <div id="marksList">
            <!-- Populated via JS -->
        </div>
    </div>

    <!-- 4. SUBMISSION (Hidden for Parents) -->
    <div class="card" id="submissionCard">
        <div class="section-title">üì§ ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÄﬁ™ﬁÅﬁ¶ﬁÄﬁ¨ﬁÖﬁ™ﬁÇﬁ∞</div>
        <div class="work-item done">
            <span>ﬁâﬁ® ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¨ ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ (Week 12)</span>
            <span style="font-size:12px; background:#d1fae5; padding:2px 6px; border-radius:4px; color:#065f46;">ﬁÄﬁ™ﬁÅﬁ¶ﬁÄﬁ¨ﬁÖﬁ®ﬁáﬁ∞ﬁñﬁ¨</span>
        </div>
        <div style="margin-top:10px;">
            <label style="font-size:13px; display:block; margin-bottom:5px;">ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¶ﬁéﬁßﬁäﬁ¶ﬁáﬁ® ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:</label>
            <input type="file" id="fileUpload" accept="image/*" style="display:none" onchange="handleFileUpload(this)">
            <button class="upload-btn" onclick="document.getElementById('fileUpload').click()">
                üì∑ ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ / ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞
            </button>
            <p id="uploadStatus" style="font-size:12px; color:#0d9488; text-align:center; display:none;">ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...</p>
        </div>
    </div>

    <!-- 5. ASK TEACHER (Hidden for Parents) -->
    <div class="card" id="chatCard">
        <div class="section-title">üí¨ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁß ﬁàﬁßﬁÄﬁ¶ﬁÜﬁ¶</div>
        <div class="chat-box" id="chatBox">
            <div style="text-align:center; color:#ccc; font-size:12px;">ﬁâﬁ¨ﬁêﬁ¨ﬁñﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</div>
        </div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="ﬁêﬁ™ﬁàﬁßﬁçﬁ¨ﬁáﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß..." style="margin:0;">
            <button class="btn" style="width:auto; margin:0; padding:0 15px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- 6. SETTINGS -->
    <div class="card">
        <div class="section-title">‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</div>
        <button class="btn" style="background:#3b82f6;" onclick="changePassword()">üîë ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞</button>
        <button class="btn btn-logout" onclick="logout()">Logout</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSEHqUQIegVjhWKpRgpJybdPaVDVroVos",
  authDomain: "islam-portal-muthamin.firebaseapp.com",
  projectId: "islam-portal-muthamin",
  storageBucket: "islam-portal-muthamin.firebasestorage.app",
  messagingSenderId: "842342714257",
  appId: "1:842342714257:web:c5daa61eee6524e7936830"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let userRole = 'student'; // 'student' or 'parent'

    // --- GLOBAL FUNCTIONS ---
    window.setRole = (role) => {
        userRole = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btnRole'+(role.charAt(0).toUpperCase()+role.slice(1))).classList.add('active');
    };

    window.login = async () => {
        const idx = document.getElementById('idx').value;
        const pass = document.getElementById('pass').value;
        if(!idx || !pass) return alert("Please fill all fields");

        // Fetch students
        const snapshot = await getDocs(collection(db, "students"));
        let found = null;
        snapshot.forEach(doc => {
            const data = doc.data();
            if(String(data.index) === String(idx) && String(data.password) === String(pass)) {
                found = { id: doc.id, ...data };
            }
        });

        if(found) {
            currentUser = found;
            loadDashboard();
        } else {
            alert("Invalid Credentials");
        }
    };

    function loadDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        // Populate Header
        document.getElementById('stName').innerText = currentUser.name;
        document.getElementById('stClass').innerText = `${currentUser.grade} - ${currentUser.class} | Index: ${currentUser.index}`;

        // Fetch Notice
        getDoc(doc(db, "settings", "notice")).then(snap => {
            if(snap.exists()) document.getElementById('noticeText').innerText = snap.data().text;
        });

        // 1. Badges Logic
        if(currentUser.badges) {
            currentUser.badges.forEach(b => {
                const el = document.getElementById(`badge-${b}`);
                if(el) el.classList.add('earned');
            });
        }

        // 2. Marks List
        let marksHtml = "";
        // Sort keys to show weeks/tests logically if needed
        Object.keys(currentUser).forEach(key => {
            if(key.startsWith('UnitTest') || key.startsWith('CA')) {
                marksHtml += `<div class="work-item"><span>${key}</span><b>${currentUser[key]}</b></div>`;
            }
        });
        document.getElementById('marksList').innerHTML = marksHtml || "<p style='color:#777;text-align:center'>No marks yet</p>";

        // 3. Chat Messages
        let chatHtml = "";
        if(currentUser.parentMessages) {
            currentUser.parentMessages.forEach(m => {
                // If text starts with [T] it's teacher, otherwise student (simple logic for now)
                // In a real app, 'sender' field is better.
                // Assuming current structure just has {text, date}. 
                // We'll treat all as "sent" for now unless marked otherwise.
                chatHtml += `<div class="msg student">${m.text}</div>`;
            });
            document.getElementById('chatBox').innerHTML = chatHtml;
        }

        // 4. Role Specific View
        if(userRole === 'parent') {
            document.getElementById('submissionCard').style.display = 'none'; // Parents can't submit work
            // Parents can use chat to talk to teacher, so keep chatCard or rename title
            document.querySelector('#chatCard .section-title').innerText = "üë®‚Äçüë©‚Äçüëß ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ¶ﬁÅﬁ∞ ﬁâﬁ¨ﬁêﬁ¨ﬁñﬁ™";
        }
    }

    // --- ACTIONS ---
    window.handleFileUpload = (input) => {
        if(input.files.length > 0) {
            const p = document.getElementById('uploadStatus');
            p.style.display = 'block';
            p.innerText = "ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁàﬁ¶ﬁÇﬁ©... (Simulated)";
            
            // NOTE: Real file upload needs Firebase Storage. 
            // Here we just simulate saving a "Submitted" status.
            setTimeout(async () => {
                await updateDoc(doc(db, "students", currentUser.id), {
                    ['WeekCurrent']: 'Submitted' // Just an example field
                });
                p.innerText = "‚úÖ ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!";
                p.style.color = "green";
                // Add badge for fun
                document.getElementById('badge-homework').classList.add('earned');
            }, 1500);
        }
    };

    window.sendMessage = async () => {
        const txt = document.getElementById('chatInput').value;
        if(!txt) return;
        
        await updateDoc(doc(db, "students", currentUser.id), {
            parentMessages: arrayUnion({ text: txt, date: new Date().toISOString() })
        });
        
        // Update UI locally
        const box = document.getElementById('chatBox');
        box.innerHTML += `<div class="msg student">${txt}</div>`;
        document.getElementById('chatInput').value = "";
        box.scrollTop = box.scrollHeight;
    };

    window.changePassword = async () => {
        const newP = prompt("Enter new password:");
        if(newP && newP.length >= 3) {
            await updateDoc(doc(db, "students", currentUser.id), { password: newP });
            alert("Password changed!");
        } else if (newP) {
            alert("Password too short");
        }
    };

    window.logout = () => { location.reload(); };

</script>
</body>
</html>
