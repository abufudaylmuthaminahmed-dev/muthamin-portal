<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</title>
    <style>
        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
        
        * { font-family: "Faruma", sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: #f4f7f6; margin: 0; padding: 10px; text-align: right; overflow-x: hidden; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        h1 { color: #00796b; text-align: center; font-size: 1.5rem; margin-bottom: 20px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { flex: 1; padding: 12px 5px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 14px; color: #666; white-space: nowrap; }
        .tab-btn.active { color: #00796b; border-bottom: 3px solid #00796b; }

        .card { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; text-align: center; }
        
        .btn { width: 100%; padding: 14px; background: #00796b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-save { background: #2e7d32; margin-top: 15px; position: sticky; bottom: 10px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }

        /* Horizontal Scrolling Filters */
        .pills-container { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .pills-container::-webkit-scrollbar { display: none; }
        .pill { padding: 8px 16px; background: #eee; border-radius: 25px; cursor: pointer; white-space: nowrap; font-size: 13px; border: 1px solid transparent; flex-shrink: 0; transition: background 0.2s; }
        .pill.active { background: #00796b; color: white; border-color: #00796b; }

        /* Responsive Table */
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; background: white; -webkit-overflow-scrolling: touch; position: relative; min-height: 100px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; font-size: 14px; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; color: #00796b; position: sticky; top: 0; z-index: 10; }

        .sub-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .sub-tab { padding: 8px 15px; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-size: 13px; white-space: nowrap; flex-shrink: 0; }
        .sub-tab.active { background: #00796b; color: white; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #00796b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .filter-label { font-size: 12px; margin: 10px 0 5px 0; color: #555; font-weight: bold; }

        @media (max-width: 600px) {
            .container { padding: 10px; }
            h1 { font-size: 1.2rem; }
            th, td { padding: 8px 4px; font-size: 12px; }
            input, select { padding: 10px; font-size: 14px; }
            .btn { padding: 12px; font-size: 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üåô ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h1>

    <div class="tabs">
        <button class="tab-btn active" id="btnParent" onclick="showTab('parentView', this)">ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞</button>
        <button class="tab-btn" id="btnTeacher" onclick="showTab('teacherView', this)">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞</button>
    </div>

    <!-- Parent Section -->
    <div id="parentView">
        <div class="card">
            <input type="number" id="searchIndex" placeholder="ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™" inputmode="numeric">
            <button class="btn" id="searchBtn" onclick="searchStudent()">ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÑﬁ¶ﬁçﬁß</button>
        </div>
        <div id="studentResults" style="display:none;">
            <div id="studentHeader" style="background:#00796b; color:white; padding:15px; border-radius:10px; margin-bottom:15px; text-align:center;"></div>
            <div class="table-container"><table id="resultsTable"></table></div>
        </div>
    </div>

    <!-- Teacher Section -->
    <div id="teacherView" style="display:none;">
        <div id="loginArea" class="card" style="text-align:center;">
            <h3>ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</h3>
            <input type="password" id="passInput" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
            <button class="btn" onclick="loginTeacher()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        </div>

        <div id="teacherPanel" style="display:none;">
            <div class="sub-tabs">
                <div class="sub-tab active" id="tabWork" onclick="setMode('work')">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁß</div>
                <div class="sub-tab" id="tabTest" onclick="setMode('test')">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞</div>
                <div class="sub-tab" id="tabCA" onclick="setMode('ca')">CA</div>
            </div>

            <div class="card" style="background:#f1f8e9; padding: 10px;">
                <select id="itemSelect" onchange="renderTeacherTable()"></select>
                
                <div class="filter-label">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞:</div>
                <div id="gradeFilter" class="pills-container"></div>
                
                <div id="classFilterSection" style="display:none;">
                    <div class="filter-label">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</div>
                    <div id="classFilter" class="pills-container"></div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞</th>
                            <th>ﬁÇﬁ¶ﬁÇﬁ∞</th>
                            <th id="valHead">ﬁÄﬁßﬁçﬁ¶ﬁåﬁ™</th>
                            <th>ﬁÇﬁØﬁìﬁ∞</th>
                        </tr>
                    </thead>
                    <tbody id="teacherTableBody"></tbody>
                </table>
            </div>
            
            <button class="btn btn-save" id="saveBtn" onclick="saveData()">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0FuKBjx_6ZwkA13pmpuqGRsqe_7NXwm6IKhdynSJgslnXwUaFWxvg5tsEY5oJYVVR/exec";
    
    let database = [];
    let currentMode = 'work';
    let selectedGrade = 'All';
    let selectedClass = 'All';
    let isFetching = false;

    function showTab(id, btn) {
        document.getElementById('parentView').style.display = id === 'parentView' ? 'block' : 'none';
        document.getElementById('teacherView').style.display = id === 'teacherView' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function loginTeacher() {
        if(document.getElementById('passInput').value === "123") {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('teacherPanel').style.display = 'block';
            loadData();
        } else alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
    }

    function loadData() {
        if(isFetching) return;
        isFetching = true;

        const body = document.getElementById('teacherTableBody');
        body.innerHTML = '<tr><td colspan="4"><span class="loader"></span> ﬁçﬁØﬁëﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...</td></tr>';
        
        const callback = 'jsonp_' + Date.now();
        window[callback] = (data) => {
            database = data;
            isFetching = false;
            setMode(currentMode);
            renderFilters();
            delete window[callback];
        };
        const script = document.createElement('script');
        script.src = `${API_URL}?prefix=${callback}&t=${Date.now()}`;
        document.body.appendChild(script);
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        const tabEl = document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1));
        if(tabEl) tabEl.classList.add('active');
        
        let options = "";
        if(mode === 'work') for(let i=1; i<=45; i++) options += `<option value="Week${i}">Week ${i}</option>`;
        else if(mode === 'test') for(let i=1; i<=10; i++) options += `<option value="Test${i}">Unit Test ${i}</option>`;
        else if(mode === 'ca') for(let i=1; i<=4; i++) options += `<option value="CA${i}">CA ${i}</option>`;
        
        document.getElementById('itemSelect').innerHTML = options;
        document.getElementById('valHead').innerText = mode === 'work' ? 'ﬁÄﬁßﬁçﬁ¶ﬁåﬁ™' : 'ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞';
        renderTeacherTable();
    }

    function renderFilters() {
        if(!database.length) return;
        
        // Grade Filter
        const grades = [...new Set(database.map(s => s.Grade))].filter(Boolean).sort((a,b)=>a-b);
        let gHtml = `<div class="pill ${selectedGrade === 'All' ? 'active' : ''}" onclick="filterGrade('All')">All</div>`;
        grades.forEach(g => {
            gHtml += `<div class="pill ${selectedGrade == g ? 'active' : ''}" onclick="filterGrade('${g}')">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞ ${g}</div>`;
        });
        document.getElementById('gradeFilter').innerHTML = gHtml;

        // Class Filter (only show if a grade is selected)
        const classSection = document.getElementById('classFilterSection');
        if(selectedGrade === 'All') {
            classSection.style.display = 'none';
            selectedClass = 'All';
        } else {
            classSection.style.display = 'block';
            const classes = [...new Set(database.filter(s => s.Grade && s.Grade.toString() === selectedGrade.toString()).map(s => s.Class))].filter(Boolean).sort();
            
            let cHtml = `<div class="pill ${selectedClass === 'All' ? 'active' : ''}" onclick="filterClass('All')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞</div>`;
            classes.forEach(c => {
                cHtml += `<div class="pill ${selectedClass == c ? 'active' : ''}" onclick="filterClass('${c}')">${c}</div>`;
            });
            document.getElementById('classFilter').innerHTML = cHtml;
        }
    }

    function filterGrade(g) { 
        if(selectedGrade === g) return;
        selectedGrade = g; 
        selectedClass = 'All'; // Reset class filter when grade changes
        renderFilters();
        renderTeacherTable(); 
    }

    function filterClass(c) {
        if(selectedClass === c) return;
        selectedClass = c;
        renderFilters();
        renderTeacherTable();
    }

    function renderTeacherTable() {
        const item = document.getElementById('itemSelect').value;
        const body = document.getElementById('teacherTableBody');
        
        if(!database.length) return;

        let filtered = database;
        
        // Filter by Grade
        if(selectedGrade !== 'All') {
            const gStr = selectedGrade.toString();
            filtered = filtered.filter(s => s.Grade && s.Grade.toString() === gStr);
        }
        
        // Filter by Class
        if(selectedClass !== 'All') {
            const cStr = selectedClass.toString();
            filtered = filtered.filter(s => s.Class && s.Class.toString() === cStr);
        }

        if(filtered.length === 0) {
            body.innerHTML = '<tr><td colspan="4">ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞</td></tr>';
            return;
        }

        let rowsHtml = '';
        for(let i=0; i < filtered.length; i++) {
            const s = filtered[i];
            let valField = "";
            let num = item.replace(/[a-zA-Z]/g, '');
            let currentVal = s[item] || "";
            let noteKey = currentMode === 'work' ? 'Note'+num : (currentMode === 'test' ? 'TNote'+num : 'CANote'+num);
            let currentNote = s[noteKey] || "";

            if(currentMode === 'work') {
                valField = `<select data-idx="${s.Index}" class="val-in"><option value="">-</option><option value="ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®" ${currentVal==='ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®'?'selected':''}>ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®</option><option value="ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠" ${currentVal==='ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠'?'selected':''}>ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</option></select>`;
            } else {
                valField = `<input type="number" data-idx="${s.Index}" class="val-in" value="${currentVal}" inputmode="numeric" style="width:60px;">`;
            }

            rowsHtml += `<tr>
                <td>${s.Index}</td>
                <td style="text-align:right;">${s.Name}<br><small style="color:#888;">${s.Grade}${s.Class}</small></td>
                <td>${valField}</td>
                <td><input type="text" data-idx="${s.Index}" class="note-in" value="${currentNote}"></td>
            </tr>`;
        }
        body.innerHTML = rowsHtml;
    }

    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const item = document.getElementById('itemSelect').value;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> ﬁêﬁ≠ﬁàﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...';

        const updates = [];
        const valInputs = document.querySelectorAll('.val-in');
        const noteInputs = document.querySelectorAll('.note-in');

        for(let i=0; i < valInputs.length; i++) {
            updates.push({
                index: valInputs[i].dataset.idx,
                val: valInputs[i].value,
                note: noteInputs[i].value
            });
        }

        // Send data using a safer fetch approach with GET params for simple Google Script communication
        const params = new URLSearchParams({
            action: 'save',
            mode: currentMode,
            item: item,
            updates: JSON.stringify(updates)
        });

        const url = `${API_URL}?${params.toString()}`;
        
        try {
            // Using a hidden script element for cross-domain save if fetch fails due to CORS
            const script = document.createElement('script');
            script.src = url + '&t=' + Date.now();
            document.body.appendChild(script);
            
            // Give it some time to process
            setTimeout(() => {
                alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞ ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁãﬁ¶ﬁÇﬁ©! ﬁùﬁ©ﬁìﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ ﬁáﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÜﬁ™ﬁëﬁ¶ ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™ﬁÜﬁÆﬁÖﬁ¨ﬁáﬁ∞ ﬁÇﬁ¶ﬁéﬁßﬁäﬁßﬁÇﬁ¨.");
                btn.disabled = false;
                btn.innerText = "ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠";
                script.remove();
            }, 2000);
            
        } catch(e) {
            console.error("Save error:", e);
            alert("ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁãﬁ®ﬁâﬁßﬁàﬁ¨ﬁáﬁ∞ﬁñﬁ¨! ﬁáﬁ¶ﬁçﬁ™ﬁÇﬁ∞ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞ ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ¶ﬁáﬁ∞ﬁàﬁß.");
            btn.disabled = false;
            btn.innerText = "ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠";
        }
    }

    function searchStudent() {
        const idxInput = document.getElementById('searchIndex');
        const idx = idxInput.value;
        if(!idx) return;
        
        const btn = document.getElementById('searchBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span>';
        
        const callback = 'search_' + Date.now();
        window[callback] = (data) => {
            btn.disabled = false;
            btn.innerText = "ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÑﬁ¶ﬁçﬁß";
            const s = data.find(x => x.Index && x.Index.toString() === idx);
            if(s) {
                document.getElementById('studentHeader').innerHTML = `<h2 style="margin:0;">${s.Name}</h2><p style="margin:5px 0 0 0; opacity:0.8;">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞: ${s.Grade} ${s.Class}</p>`;
                document.getElementById('studentResults').style.display = 'block';
                
                let html = "<thead><tr><th>ﬁÑﬁ¶ﬁáﬁ®</th><th>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß</th></tr></thead><tbody>";
                for(let i=1; i<=10; i++) {
                    if(s['Week'+i]) html += `<tr><td>Week ${i}</td><td>${s['Week'+i]}</td></tr>`;
                }
                html += "</tbody>";
                document.getElementById('resultsTable').innerHTML = html;
                window.scrollTo({ top: document.getElementById('studentResults').offsetTop - 20, behavior: 'smooth' });
            } else alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™");
            delete window[callback];
        };
        const script = document.createElement('script');
        script.src = `${API_URL}?prefix=${callback}&t=${Date.now()}`;
        document.body.appendChild(script);
    }
</script>
</body>
</html>
