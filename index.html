<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
        * { font-family: "Faruma", sans-serif; box-sizing: border-box; }
        body { background-color: #f4f7f6; margin: 0; padding: 10px; text-align: right; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; min-height: 85vh; }
        
        h1 { color: #00897b; text-align: center; margin-bottom: 25px; font-size: 1.8rem; border-bottom: 2px solid #e0f2f1; padding-bottom: 10px; }
        
        /* ADMIN TRIGGER */
        .admin-trigger { position: absolute; top: 0; left: 0; width: 50px; height: 50px; z-index: 200; cursor: default; opacity: 0; }
        .admin-input-group { display: none; position: absolute; top: 40px; left: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1001; border: 1px solid #eee; }
        .mini-input { width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; outline: none; }
        .mini-btn { padding: 8px 12px; background: #00796b; color: white; border: none; border-radius: 4px; cursor: pointer; }

        .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card-highlight { background: #e0f2f1; border: 1px dashed #00897b; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 16px; text-align: center; outline: none; transition: 0.3s; font-family: inherit;}
        input:focus, textarea:focus { border-color: #00796b; box-shadow: 0 0 0 2px rgba(0,121,107,0.1); }

        /* INPUT STYLES FOR TEACHER */
        .v-in { width: 100% !important; min-width: 80px; height: 38px; font-weight: bold; border: 1px solid #b2dfdb !important; padding: 5px !important; border-radius: 4px; }
        select.v-in { font-size: 13px !important; padding: 0 5px !important; height: 35px !important; }
        input[type="number"].v-in { font-size: 14px !important; }
        .n-in { text-align: right !important; min-width: 150px; font-size: 13px !important; background: #fafafa; }
        
        .btn { width: 100%; padding: 14px; background: #00796b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; transition: 0.2s; display:flex; align-items:center; justify-content:center; gap:8px;}
        .btn:active { transform: scale(0.98); }
        .btn-mat { background: #f57c00; }
        .btn-add { background: #1976d2; padding: 6px 12px; font-size: 13px; width: auto; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .btn-del { background: #ef5350; padding: 4px 8px; font-size: 11px; width: auto; color: white; border: none; border-radius: 4px; cursor: pointer;}
        .btn-edit { background: #fb8c00; padding: 5px 10px; font-size: 14px; width: auto; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-save { position: fixed; bottom: 20px; right: 20px; left: 20px; width: calc(100% - 40px); z-index: 100; background: #2e7d32; box-shadow: 0 4px 15px rgba(46,125,50,0.4); max-width: 960px; margin: 0 auto; }

        /* RESULT STYLES */
        .result-header { text-align: center; background: #004d40; color: white; padding: 20px; border-radius: 10px 10px 0 0; margin-bottom: 20px; }
        .result-section { margin-bottom: 25px; }
        .result-title { font-size: 16px; font-weight: bold; color: #00796b; border-bottom: 2px solid #b2dfdb; padding-bottom: 5px; margin-bottom: 10px; }
        .result-item { display: flex; justify-content: space-between; align-items: center; background: white; border: 1px solid #eee; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-right: 4px solid #ccc; transition:0.2s; }
        .result-item:hover { transform: translateX(-3px); }
        .result-item.done { border-right-color: #2e7d32; }
        .result-item.pending { border-right-color: #f57c00; }
        .result-item.incomplete { border-right-color: #c62828; }
        .score-circle { width: 45px; height: 45px; background: #f0f4c3; color: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 2px solid #cddc39; }
        
        .grade-badge { padding: 3px 8px; border-radius: 4px; color: white; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .g-A-star { background: #fbc02d; color: #333; } .g-A { background: #43a047; } .g-B { background: #1976d2; } .g-C { background: #fb8c00; } .g-Fail { background: #e53935; }

        /* Teacher Table */
        .table-container { width: 100%; overflow-x: auto; margin-top: 15px; border-radius: 10px; border: 1px solid #eee; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        th { background: #e0f2f1; color: #00695c; font-weight: bold; white-space: nowrap; }
        tr:nth-child(even) { background-color: #fafafa; }
        
        .pills { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; }
        .pill { padding: 8px 16px; background: #eceff1; border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 13px; color: #546e7a; font-weight: bold; }
        .pill.active { background: #00796b; color: white; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #00796b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .drop-zone { border: 2px dashed #ccc; padding: 20px; border-radius: 10px; background: #fafafa; cursor: pointer; display:block; margin:10px 0;}
        .drop-zone:hover { border-color: #00796b; background: #e0f2f1; }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-trigger" onclick="toggleAdmin()" title="Admin Login"></div>
    <div id="adminInputGroup" class="admin-input-group">
        <p style="margin:0 0 10px 0; font-size:12px; color:#555;">Admin Login</p>
        <input type="password" id="headerPass" class="mini-input" placeholder="Password">
        <button onclick="headerLogin()" class="mini-btn">Go</button>
    </div>

    <h1>üåô ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h1>

    <!-- PARENT VIEW -->
    <div id="viewParent">
        <div class="card" style="text-align:center;">
            <h3 style="margin-top:0; color:#455a64;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞</h3>
            <p style="font-size:13px; color:#78909c;">ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p>
            <input type="number" id="pIdx" placeholder="Index Number" inputmode="numeric" style="font-size:18px; letter-spacing: 2px;">
            <button class="btn" id="pBtn" onclick="searchStudent()"><span>üîç</span> ﬁÑﬁ¶ﬁáﬁ∞ﬁçﬁ¶ﬁàﬁß</button>
        </div>

        <div class="card card-highlight">
            <h3 style="margin-top:0; color:#00695c;">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</h3>
            <p style="font-size:13px; color:#555; margin-bottom:15px;">ﬁäﬁÆﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁßﬁáﬁ® ﬁÇﬁØﬁìﬁ∞ﬁêﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁàﬁØﬁÜﬁ∞ﬁùﬁ©ﬁìﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁáﬁ∞ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞</p>
            <button class="btn btn-mat" onclick="openMaterials()"><span>üì•</span> ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
        </div>
        <div id="pRes" style="display:none; animation: fadeIn 0.5s;"></div>
    </div>

    <!-- TEACHER VIEW -->
    <div id="viewTeacher" style="display: none;">
        <div id="teacherPanel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:white; padding:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <button class="btn" style="width:auto; padding:8px 15px; margin:0; background:#78909c;" onclick="logout()">‚Üê Home</button>
                <div style="font-weight:bold; color:#00796b;">Admin Panel</div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-add" style="background:#43a047;" onclick="openStudentModal()" title="Add Single Student">+1</button>
                    <button class="btn btn-add" style="background:#00897b;" onclick="openBulkModal()" title="Import from Excel">Excel üìó</button>
                    <button class="btn btn-add" style="background:#f57c00;" onclick="openMatManager()" title="Manage Files">File üìÇ</button>
                </div>
            </div>
            
            <div class="card">
                <div class="pills">
                    <div class="pill active" id="m_work" onclick="setMode('work')">Work (Weekly)</div>
                    <div class="pill" id="m_test" onclick="setMode('test')">Unit Tests</div>
                    <div class="pill" id="m_ca" onclick="setMode('ca')">CA / Exams</div>
                </div>
                
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:15px;">
                    <div style="flex:1; min-width:150px;">
                        <small style="color:#666; font-weight:bold;">Select Item:</small>
                        <div style="display:flex; gap:5px;">
                            <select id="itemSelect" onchange="renderTeacherTable()"></select>
                            <button class="btn btn-add" style="background:#00695c; padding:0 12px; font-size:18px;" onclick="openResultModal()" title="Upload Marks">üì§</button>
                        </div>
                    </div>
                    
                    <div id="totalDiv" style="width:130px; display:none; flex-direction:column;">
                        <small style="color:#666; font-weight:bold;">Total Marks:</small>
                        <div style="display:flex; gap:2px;">
                            <input type="number" id="totalMarks" value="20" style="padding:5px; height:35px;">
                            <button onclick="saveTotalMark()" style="background:#2e7d32; border:none; color:white; border-radius:4px; cursor:pointer; width:35px;" title="Save Total">üíæ</button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:15px;">
                    <small style="color:#666; font-weight:bold;">Filter Students:</small>
                    <div id="gradeFilter" class="pills" style="margin-bottom:5px;"></div>
                    <div id="classFilter" class="pills"></div>
                </div>
                
                <div style="text-align:right; margin-top:10px;">
                     <button onclick="fetchData()" style="background:none; border:none; color:#00695c; font-size:13px; cursor:pointer; text-decoration:underline;">üîÑ Refresh Data</button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width:50px;">Idx</th>
                            <th style="text-align:right;">Name</th>
                            <th id="valHead" style="width:100px;">Status/Mark</th>
                            <th id="thG" style="display:none; width:50px;">%</th>
                            <th>Note</th>
                            <th style="width:40px;">Msg</th>
                            <th style="width:50px;">Act</th>
                        </tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
            
            <button class="btn btn-save" id="sBtn" onclick="saveTeacherData()">üíæ Save Changes</button>
            <div style="height:80px;"></div>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- 1. Add Student -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <h3 style="color:#00796b;">ﬁáﬁß ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
        <input type="number" id="newStIndex" placeholder="Index Number">
        <input type="text" id="newStName" placeholder="Name">
        <div style="display:flex; gap:10px;">
            <input type="text" id="newStGrade" placeholder="Grade">
            <input type="text" id="newStClass" placeholder="Class">
        </div>
        <button class="btn btn-add" style="background:#2e7d32; margin-top:15px; width:100%;" onclick="addNewStudent()">Save Student</button>
        <button class="btn" style="background:#b0bec5; color:#333; margin-top:10px;" onclick="closeModal('studentModal')">Cancel</button>
    </div>
</div>

<!-- 2. EDIT Student Modal (NEW) -->
<div id="editStudentModal" class="modal">
    <div class="modal-content">
        <h3 style="color:#f57c00;">Edit Student Details</h3>
        <input type="hidden" id="editStId">
        <label style="font-size:12px; display:block; text-align:left;">Index:</label>
        <input type="number" id="editStIndex">
        <label style="font-size:12px; display:block; text-align:left;">Name:</label>
        <input type="text" id="editStName">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label style="font-size:12px;">Grade:</label><input type="text" id="editStGrade"></div>
            <div style="flex:1"><label style="font-size:12px;">Class:</label><input type="text" id="editStClass"></div>
        </div>
        <button class="btn btn-add" style="background:#2e7d32; margin-top:15px; width:100%;" onclick="saveEditStudent()">Update Details</button>
        
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <button class="btn" style="background:#c62828; color:white;" onclick="deleteStudent()">üóë Delete Student</button>
        
        <button class="btn" style="background:#b0bec5; color:#333; margin-top:10px;" onclick="closeModal('editStudentModal')">Cancel</button>
    </div>
</div>

<!-- 3. Bulk Import -->
<div id="bulkModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
        <h3 style="color:#00796b;">Excel File Import</h3>
        <p style="font-size:13px; color:#666;">Format: <b>Index | Name | Grade | Class</b></p>
        <label for="excelFile" class="drop-zone"><div style="font-size:30px;">üìÇ</div><div style="color:#00796b;">Click to Upload</div></label>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none;">
        <div id="previewArea" style="display:none; margin-top:15px; background:#f9f9f9; padding:10px; border:1px solid #eee; text-align:right;">
            <div id="excelPreview"></div>
            <button class="btn btn-add" style="background:#2e7d32; margin-top:10px; width:100%;" id="btnConfirmBulk" onclick="confirmExcelUpload()">Confirm & Upload</button>
        </div>
        <button class="btn" style="background:#b0bec5; color:#333; margin-top:15px;" onclick="closeModal('bulkModal'); resetBulk();">Cancel</button>
    </div>
</div>

<!-- 4. Result Import -->
<div id="resultModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <h3 style="color:#00796b;">ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
        <p style="font-size:14px; color:#e65100; font-weight:bold;" id="resultTargetName">Target: -</p>
        <p style="font-size:12px; color:#666;">Format: <b>Index | Marks</b></p>
        <label for="resExcelFile" class="drop-zone"><div style="font-size:25px;">üìä</div><div>Upload Excel</div></label>
        <input type="file" id="resExcelFile" accept=".xlsx, .xls" style="display:none;">
        <div id="resPreviewArea" style="display:none; margin-top:15px; background:#f9f9f9; padding:10px; border:1px solid #eee; text-align:right;">
            <div id="resExcelPreview"></div>
            <button class="btn btn-add" style="background:#2e7d32; margin-top:10px; width:100%;" id="btnConfirmRes" onclick="confirmResultUpload()">Upload Marks</button>
        </div>
        <button class="btn" style="background:#b0bec5; color:#333; margin-top:15px;" onclick="closeModal('resultModal'); resetResBulk();">Cancel</button>
    </div>
</div>

<div id="matModal" class="modal"><div class="modal-content"><h2 style="color:#00796b;">üìö ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</h2><div id="matListParent" style="min-height:100px;">Loading...</div><button class="btn" style="background:#b0bec5; margin-top:15px; color:#333;" onclick="closeModal('matModal')">Close</button></div></div>
<div id="matManagerModal" class="modal"><div class="modal-content"><h3 style="color:#00796b;">Manage Materials</h3><input type="text" id="newMatTitle" placeholder="Title"><input type="text" id="newMatLink" placeholder="Link (URL)"><button class="btn btn-add" style="background:#1976d2; width:100%; margin-top:5px;" onclick="addMaterial()">+ Add Item</button><hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;"><div id="matListTeacher" style="text-align:left; max-height:300px; overflow-y:auto;"></div><button class="btn" style="background:#b0bec5; color:#333; margin-top:15px;" onclick="closeModal('matManagerModal')">Close</button></div></div>

<div id="msgModal" class="modal"><div class="modal-content"><h3 style="color:#00796b;">ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁßﬁéﬁ¨ ﬁâﬁ¨ﬁêﬁ¨ﬁñﬁ™</h3><div id="msgContent" style="text-align:right; background:#f1f8e9; padding:15px; border-radius:8px; margin-bottom:15px;"></div><button class="btn" style="background:#b0bec5; color:#333;" onclick="closeModal('msgModal')">Close</button></div></div>

<div id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSEHqUQIegVjhWKpRgpJybdPaVDVroVos",
      authDomain: "islam-portal-muthamin.firebaseapp.com",
      projectId: "islam-portal-muthamin",
      storageBucket: "islam-portal-muthamin.firebasestorage.app",
      messagingSenderId: "842342714257",
      appId: "1:842342714257:web:c5daa61eee6524e7936830"
    };

    let db;
    let students = [];
    let materials = [];
    let examConfig = {};
    let mode = 'work';
    let selGrade = 'All';
    let selClass = 'All';
    let parsedExcelData = [];
    let parsedResultData = [];

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    // ADMIN
    window.toggleAdmin = () => {
        const grp = document.getElementById('adminInputGroup');
        grp.style.display = grp.style.display === 'block' ? 'none' : 'block';
        if(grp.style.display === 'block') document.getElementById('headerPass').focus();
    };
    window.headerLogin = () => {
        if(document.getElementById('headerPass').value === "123") {
            document.getElementById('viewParent').style.display = 'none';
            document.getElementById('viewTeacher').style.display = 'block';
            document.getElementById('adminInputGroup').style.display = 'none';
            document.getElementById('headerPass').value = '';
            window.fetchData();
        } else alert("ﬁÜﬁ™ﬁÅﬁ∞ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞!");
    };
    window.logout = () => {
        document.getElementById('viewTeacher').style.display = 'none';
        document.getElementById('viewParent').style.display = 'block';
    };

    // FETCH DATA
    window.fetchData = async (showLoader = true) => {
        if(!db) return alert("Database connection failed!");
        if(showLoader) document.getElementById('tBody').innerHTML = '<tr><td colspan="7" style="padding:20px;"><div class="loader"></div> Loading...</td></tr>';
        try {
            const sSnap = await getDocs(collection(db, "students"));
            students = [];
            sSnap.forEach((doc) => students.push({ id: doc.id, ...doc.data() }));
            const mSnap = await getDocs(collection(db, "materials"));
            materials = [];
            mSnap.forEach((doc) => materials.push({ id: doc.id, ...doc.data() }));
            try { const confSnap = await getDoc(doc(db, "settings", "examConfig")); if(confSnap.exists()) examConfig = confSnap.data(); } catch(e) {}
            window.updateFilters(); window.setMode(mode); window.renderParentMaterials();
        } catch(e) { console.error(e); document.getElementById('tBody').innerHTML = '<tr><td colspan="7" style="color:red">Error</td></tr>'; }
    };

    // TEACHER LOGIC
    window.setMode = (m) => {
        mode = m;
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        document.getElementById('m_'+m).classList.add('active');
        let sel = document.getElementById('itemSelect'); sel.innerHTML = "";
        if(m=='work') {
            for(let i=1;i<=45;i++) sel.innerHTML += `<option value="Week${i}">Week ${i}</option>`;
            document.getElementById('totalDiv').style.display = 'none';
            document.getElementById('thG').style.display = 'none';
            document.getElementById('valHead').innerText = 'Status';
        } else {
            document.getElementById('totalDiv').style.display = 'flex';
            document.getElementById('thG').style.display = 'table-cell';
            document.getElementById('valHead').innerText = 'Marks';
            let prefix = m=='test' ? 'UnitTest' : 'CA';
            let count = m=='test' ? 10 : 4;
            for(let i=1;i<=count;i++) sel.innerHTML += `<option value="${prefix}${i}">${m=='test'?'Unit Test':'CA'} ${i}</option>`;
        }
        window.renderTeacherTable();
    };

    window.saveTotalMark = async () => {
        const item = document.getElementById('itemSelect').value;
        const val = document.getElementById('totalMarks').value;
        if(!item || !val) return;
        try { await setDoc(doc(db, "settings", "examConfig"), { [item]: val }, { merge: true }); examConfig[item] = val; showToast("Total Saved!"); window.renderTeacherTable(); } catch(e) { alert("Error saving total"); }
    };

    window.renderTeacherTable = () => {
        const item = document.getElementById('itemSelect').value;
        let defaultTotal = mode === 'test' ? 20 : 100;
        let currentTotal = examConfig[item] ? parseInt(examConfig[item]) : defaultTotal;
        if(mode !== 'work') document.getElementById('totalMarks').value = currentTotal;

        let filtered = students;
        if(selGrade !== 'All') filtered = filtered.filter(s => String(s.grade) === String(selGrade));
        if(selClass !== 'All') filtered = filtered.filter(s => String(s.class) === String(selClass));

        let html = "";
        filtered.sort((a,b) => (parseInt(a.index) || 0) - (parseInt(b.index) || 0)).forEach(s => {
            let val = s[item] || "";
            let note = s[item + "_note"] || "";
            let hasMsg = s.parentMessages && s.parentMessages.length > 0;
            let input = mode === 'work' ? 
                `<select class="v-in" data-id="${s.id}" data-orig="${val}"><option value="">-</option><option value="ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®" ${val=='ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®'?'selected':''}>ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®</option><option value="ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠" ${val=='ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠'?'selected':''}>ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</option><option value="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠" ${val=='ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠'?'selected':''}>ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ™ﬁàﬁ≠</option></select>` : 
                `<input type="number" class="v-in" data-id="${s.id}" data-orig="${val}" value="${val}" placeholder="0" oninput="updRow(this, ${currentTotal})">`;
            let gradeHtml = mode !== 'work' && val ? window.calcGradeHtml(val, currentTotal) : '';
            let msgBtn = hasMsg ? `<button onclick='viewMessages(${JSON.stringify(s.parentMessages)})' style="border:none; background:#ffeb3b; border-radius:50%; width:25px; height:25px; cursor:pointer;">üì©</button>` : `<span style="color:#ccc;">-</span>`;

            // ADDED EDIT BUTTON COLUMN
            html += `<tr><td><b>${s.index}</b></td><td style="text-align:right">${s.name}<br><small style="color:#888;">${s.grade}${s.class}</small></td><td>${input} <div id="g-${s.id}" style="margin-top:2px;">${gradeHtml}</div></td>${mode!='work' ? `<td><small id="p-${s.id}">${val ? Math.round((val/currentTotal)*100)+'%' : ''}</small></td>` : ''}<td><input type="text" class="n-in" data-id="${s.id}" data-orig-note="${note}" value="${note}" placeholder="..."></td><td>${msgBtn}</td><td><button class="btn-edit" onclick="openEditStudent('${s.id}')">‚úèÔ∏è</button></td></tr>`;
        });
        document.getElementById('tBody').innerHTML = html || "<tr><td colspan='7' style='padding:20px; color:#777;'>No Data</td></tr>";
    };

    window.saveTeacherData = async () => {
        const btn = document.getElementById('sBtn');
        const item = document.getElementById('itemSelect').value;
        const inputs = document.querySelectorAll('.v-in');
        let batchPromises = []; let changeCount = 0;
        btn.disabled = true; btn.innerText = "Saving...";
        inputs.forEach((inp) => {
            const id = inp.dataset.id; const val = inp.value;
            const note = document.querySelector(`.n-in[data-id="${id}"]`).value;
            if (val !== inp.dataset.orig || note !== document.querySelector(`.n-in[data-id="${id}"]`).dataset.origNote) {
                let update = {}; update[item] = val; update[item + "_note"] = note;
                batchPromises.push(updateDoc(doc(db, "students", id), update)); changeCount++;
            }
        });
        if (changeCount === 0) { showToast("No changes."); btn.disabled = false; btn.innerText = "üíæ Save Changes"; return; }
        await Promise.all(batchPromises); showToast("Saved!"); btn.disabled = false; btn.innerText = "üíæ Save Changes"; window.fetchData(false);
    };

    // --- NEW: EDIT & DELETE STUDENT LOGIC ---
    window.openEditStudent = (id) => {
        const s = students.find(x => x.id === id);
        if(!s) return;
        document.getElementById('editStId').value = s.id;
        document.getElementById('editStIndex').value = s.index;
        document.getElementById('editStName').value = s.name;
        document.getElementById('editStGrade').value = s.grade;
        document.getElementById('editStClass').value = s.class;
        document.getElementById('editStudentModal').style.display = 'block';
    };

    window.saveEditStudent = async () => {
        const id = document.getElementById('editStId').value;
        const idx = document.getElementById('editStIndex').value;
        const name = document.getElementById('editStName').value;
        const grade = document.getElementById('editStGrade').value;
        const cls = document.getElementById('editStClass').value;
        
        if(!id || !idx || !name) return alert("Please fill details");
        
        try {
            await updateDoc(doc(db, "students", id), { index: idx, name: name, grade: grade, class: cls });
            showToast("Student Updated!");
            closeModal('editStudentModal');
            window.fetchData(false);
        } catch(e) { console.error(e); alert("Error updating student"); }
    };

    window.deleteStudent = async () => {
        const id = document.getElementById('editStId').value;
        if(!id) return;
        if(confirm("Are you sure you want to DELETE this student? This cannot be undone!")) {
            try {
                await deleteDoc(doc(db, "students", id));
                showToast("Student Deleted");
                closeModal('editStudentModal');
                window.fetchData();
            } catch(e) { console.error(e); alert("Error deleting student"); }
        }
    };

    // MODALS & UTILS
    window.openMaterials = () => { document.getElementById('matModal').style.display = "block"; window.renderParentMaterials(); };
    window.openMatManager = () => { document.getElementById('matManagerModal').style.display = "block"; window.renderTeacherMaterials(); };
    window.openStudentModal = () => { document.getElementById('studentModal').style.display = "block"; };
    window.openBulkModal = () => { document.getElementById('bulkModal').style.display = "block"; };
    window.closeModal = (id) => { document.getElementById(id).style.display = "none"; };
    window.resetBulk = () => { document.getElementById('excelFile').value = ''; document.getElementById('previewArea').style.display = 'none'; parsedExcelData = []; };
    window.resetResBulk = () => { document.getElementById('resExcelFile').value = ''; document.getElementById('resPreviewArea').style.display = 'none'; parsedResultData = []; };
    
    // Excel handlers
    document.getElementById('excelFile').addEventListener('change', (e) => {
        const reader = new FileReader(); reader.onload = (e) => {
            const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).SheetNames[0]], {header: 1});
            parsedExcelData = []; let html = '<table style="width:100%;font-size:12px;"><tr><th>Idx</th><th>Name</th></tr>';
            json.forEach((row, i) => { if(row.length>=2 && (i>0||!isNaN(row[0]))) { parsedExcelData.push({index:row[0], name:row[1], grade:row[2]||'', class:row[3]||''}); if(parsedExcelData.length<=5) html+=`<tr><td>${row[0]}</td><td>${row[1]}</td></tr>`; }});
            document.getElementById('excelPreview').innerHTML = html+"</table>"; document.getElementById('previewArea').style.display='block';
        }; reader.readAsArrayBuffer(e.target.files[0]);
    });
    window.confirmExcelUpload = async () => {
        let success=0; let promises=[];
        for (let s of parsedExcelData) { if(!students.some(e=>String(e.index)==String(s.index)) && s.index) promises.push(addDoc(collection(db, "students"), {index:String(s.index), name:String(s.name), grade:String(s.grade), class:String(s.class)}).then(()=>success++)); }
        await Promise.all(promises); window.fetchData(); closeModal('bulkModal'); showToast(`Added: ${success}`);
    };
    
    window.openResultModal = () => {
        if(!document.getElementById('itemSelect').value) return alert("Select Item first");
        document.getElementById('resultTargetName').innerText = "Target: " + document.getElementById('itemSelect').value;
        document.getElementById('resultModal').style.display = "block";
    };
    document.getElementById('resExcelFile').addEventListener('change', (e) => {
        const reader = new FileReader(); reader.onload = (e) => {
            const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).SheetNames[0]], {header: 1});
            parsedResultData = []; let html = '<table style="width:100%;font-size:12px;"><tr><th>Idx</th><th>Mark</th></tr>';
            json.forEach((row, i) => { if(row.length>=2 && (i>0||!isNaN(row[0]))) { parsedResultData.push({index:row[0], mark:row[1]}); if(parsedResultData.length<=5) html+=`<tr><td>${row[0]}</td><td>${row[1]}</td></tr>`; }});
            document.getElementById('resExcelPreview').innerHTML = html+"</table>"; document.getElementById('resPreviewArea').style.display='block';
        }; reader.readAsArrayBuffer(e.target.files[0]);
    });
    window.confirmResultUpload = async () => {
        const item = document.getElementById('itemSelect').value; let success=0; let promises=[];
        for(let r of parsedResultData) { const s = students.find(x=>String(x.index)==String(r.index)); if(s) promises.push(updateDoc(doc(db, "students", s.id), {[item]:String(r.mark)}).then(()=>success++)); }
        await Promise.all(promises); window.fetchData(); closeModal('resultModal'); showToast(`Updated: ${success}`);
    };

    window.addNewStudent = async () => {
        const idx = document.getElementById('newStIndex').value; const name = document.getElementById('newStName').value;
        if(idx && name) { await addDoc(collection(db, "students"), {index:idx, name:name, grade:document.getElementById('newStGrade').value, class:document.getElementById('newStClass').value}); window.fetchData(); closeModal('studentModal'); }
    };
    window.addMaterial = async () => {
        const t = document.getElementById('newMatTitle').value; const l = document.getElementById('newMatLink').value;
        if(t && l) { await addDoc(collection(db, "materials"), {title:t, link:l}); window.renderTeacherMaterials(); }
    };
    window.removeMaterial = async (id) => { await deleteDoc(doc(db, "materials", id)); window.renderTeacherMaterials(); };
    window.renderTeacherMaterials = () => { document.getElementById('matListTeacher').innerHTML = materials.map(m=>`<div class="mat-item"><span>${m.title}</span><button class="btn-del" onclick="removeMaterial('${m.id}')">Del</button></div>`).join(''); };
    window.renderParentMaterials = () => { document.getElementById('matListParent').innerHTML = materials.length ? materials.map(m=>`<a href="${m.link}" target="_blank" class="mat-link"><span>${m.title}</span><span>üì•</span></a>`).join('') : "<p style='text-align:center;color:#999'>No materials</p>"; };

    // SEARCH & PARENT VIEW
    window.searchStudent = () => {
        const idx = document.getElementById('pIdx').value; if(!idx) return showToast("Index Required");
        const btn = document.getElementById('pBtn'); btn.innerHTML = `<div class="loader" style="width:15px;height:15px;"></div>`;
        const s = students.find(x => String(x.index) === String(idx));
        const res = document.getElementById('pRes');
        setTimeout(() => {
            btn.innerHTML = `<span>üîç</span> ﬁÑﬁ¶ﬁáﬁ∞ﬁçﬁ¶ﬁàﬁß`;
            if(s) {
                const getStatusClass = (status) => { if(status === 'ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®') return 'done'; if(status === 'ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠') return 'pending'; if(status === 'ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠') return 'incomplete'; return ''; };
                const getG = (val, itemName, defaultTotal) => { if(!val) return ''; let total = examConfig[itemName] ? parseInt(examConfig[itemName]) : defaultTotal; let g = window.calcGrade(val, total); return `<span class="grade-badge ${g.cls}">${g.lbl}</span>`; };
                let html = `<div class="result-header"><h2 style="margin:0;">${s.name}</h2><div style="opacity:0.8; margin-top:5px; font-size:14px;">Index: ${s.index} | Class: ${s.grade}${s.class}</div></div><div style="padding: 0 20px 20px 20px;"><div class="result-section"><div class="result-title">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞</div><div style="max-height:300px; overflow-y:auto; padding-right:5px;">`;
                let hasWeek = false; for(let i=45; i>=1; i--) { let v = s['Week'+i]; let n = s['Week'+i+'_note']; if(v) { hasWeek = true; html += `<div class="result-item ${getStatusClass(v)}"><div><span style="font-weight:bold; color:#555;">Week ${i}</span>${n ? `<div style="font-size:12px; color:#888;">"${n}"</div>`:''}</div><div style="font-weight:bold; color:#00796b;">${v}</div></div>`; } }
                if(!hasWeek) html += `<div style="color:#999; text-align:center; padding:10px;">No records</div>`; html += `</div></div>`;
                html += `<div class="result-section"><div class="result-title">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞</div>`; let hasTest = false; for(let i=1; i<=10; i++) { let v = s['UnitTest'+i]; if(v) { hasTest = true; html += `<div class="result-item"><span>Unit Test ${i}</span><div style="display:flex; align-items:center; gap:10px;">${getG(v, 'UnitTest'+i, 20)}<div class="score-circle">${v}</div></div></div>`; } } if(!hasTest) html += `<div style="color:#999; text-align:center; padding:10px;">No records</div>`; html += `</div>`;
                html += `<div class="result-section"><div class="result-title">CA / Exam</div>`; let hasCa = false; for(let i=1; i<=4; i++) { let v = s['CA'+i]; if(v) { hasCa = true; html += `<div class="result-item"><span>CA / Exam ${i}</span><div style="display:flex; align-items:center; gap:10px;">${getG(v, 'CA'+i, 100)}<div class="score-circle" style="background:#e0f7fa; border-color:#00bcd4;">${v}</div></div></div>`; } } if(!hasCa) html += `<div style="color:#999; text-align:center; padding:10px;">No records</div>`; html += `</div><div class="result-section" style="background:#f1f8e9; padding:15px; border-radius:10px; border:1px solid #c5e1a5;"><div style="font-weight:bold; color:#33691e; margin-bottom:10px;">Send Message to Teacher:</div><textarea id="parentMsgInput" placeholder="Write here..." rows="3"></textarea><button class="btn" style="background:#558b2f; margin-top:5px;" onclick="sendParentMsg('${s.id}')">Send ‚û§</button></div></div>`;
                res.innerHTML = html; res.style.display = "block";
            } else { res.innerHTML = `<div style="text-align:center; padding:30px; color:#c62828;"><h3>Not Found!</h3></div>`; res.style.display = "block"; }
        }, 300);
    };
    window.sendParentMsg = async (sid) => { const txt = document.getElementById('parentMsgInput').value; if(!txt.trim()) return alert("Message is empty"); try { await updateDoc(doc(db, "students", sid), { parentMessages: arrayUnion({ text: txt, date: new Date().toISOString().split('T')[0] }) }); alert("Sent!"); document.getElementById('parentMsgInput').value = ""; } catch(e) { alert("Error"); } };
    window.viewMessages = (msgArray) => { if(!msgArray || msgArray.length === 0) return alert("No messages"); const lastMsg = msgArray[msgArray.length - 1]; document.getElementById('msgContent').innerHTML = `<small style="color:#777;">Date: ${lastMsg.date}</small><br><p style="font-size:16px;">"${lastMsg.text}"</p><hr><small>Total Messages: ${msgArray.length}</small>`; document.getElementById('msgModal').style.display = "block"; };

    window.calcGrade = (m, t) => { let p = (m/t)*100; if(isNaN(p)) return {lbl:'-', cls:''}; if(p>=90) return {lbl:'A*', cls:'g-A-star'}; if(p>=80) return {lbl:'A', cls:'g-A'}; if(p>=70) return {lbl:'B', cls:'g-B'}; if(p>=60) return {lbl:'C', cls:'g-C'}; return {lbl:'Fail', cls:'g-Fail'}; };
    window.calcGradeHtml = (val, total) => { let g = window.calcGrade(val, total); return `<span class="grade-badge ${g.cls}">${g.lbl}</span>`; };
    window.updRow = (el, t) => { document.getElementById('g-'+el.dataset.id).innerHTML = window.calcGradeHtml(el.value, t); };
    window.setGradeFilter = (g) => { selGrade = g; selClass = 'All'; window.updateFilters(); window.renderTeacherTable(); };
    window.setClassFilter = (c) => { selClass = c; window.updateFilters(); window.renderTeacherTable(); };
    window.updateFilters = () => { const grades = [...new Set(students.map(s => s.grade))].filter(Boolean).sort(); let gHtml = `<div class="pill ${selGrade=='All'?'active':''}" onclick="setGradeFilter('All')">All</div>`; grades.forEach(g => gHtml += `<div class="pill ${selGrade==g?'active':''}" onclick="setGradeFilter('${g}')">Gr ${g}</div>`); document.getElementById('gradeFilter').innerHTML = gHtml; let cHtml = ''; if(selGrade !== 'All') { const classes = [...new Set(students.filter(s => s.grade == selGrade).map(s => s.class))].filter(Boolean).sort(); cHtml = `<div class="pill ${selClass=='All'?'active':''}" onclick="setClassFilter('All')">All</div>`; classes.forEach(c => cHtml += `<div class="pill ${selClass==c?'active':''}" onclick="setClassFilter('${c}')">${c}</div>`); } document.getElementById('classFilter').innerHTML = cHtml; };
    function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.opacity='1'; t.style.bottom='80px'; setTimeout(()=>t.style.opacity='0', 3000); }
</script>
</body>
</html>
