<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</title>
    <style>
        /* ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁêﬁ¨ﬁìﬁ¶ﬁïﬁ∞ */
        @font-face {
            font-family: 'Faruma';
            src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff');
        }
        @font-face {
            font-family: 'MV Waheed';
            src: local('MV Waheed'), url('https://fonts.cdnfonts.com/s/73114/MV_Waheed.woff') format('woff');
        }

        * { 
            font-family: "Faruma", "MV Waheed", sans-serif; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 10px; 
            text-align: right; 
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }

        h1 { color: #00796b; text-align: center; font-family: "MV Waheed"; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: none; 
            cursor: pointer; font-weight: bold; font-size: 16px; color: #666;
        }
        .tab-btn.active { color: #00796b; border-bottom: 3px solid #00796b; }

        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .sub-tab { padding: 8px 15px; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-size: 13px; color: #555; transition: 0.3s; }
        .sub-tab.active { background: #00796b; color: white; }

        .card { background: #e0f2f1; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        input, select, textarea { 
            width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; 
            border-radius: 8px; text-align: center; font-size: 15px;
        }
        
        .btn { 
            width: 100%; padding: 12px; background: #00796b; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
            display: block;
        }
        .btn-save { background: #2e7d32; margin-top: 15px; }

        .table-container { overflow-x: auto; margin-top: 15px; max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; color: #00796b; position: sticky; top: 0; z-index: 10; }

        .status { padding: 4px 10px; border-radius: 20px; font-size: 12px; color: white; font-weight: bold; }
        .status-done { background: #2e7d32; }
        .status-pending { background: #d32f2f; }
        .status-incomplete { background: #f57f17; }
        
        .pills-group { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 8px; }
        .pills-label { font-size: 12px; color: #555; margin-bottom: 5px; font-weight: bold; }
        .pills { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .pill { padding: 6px 12px; background: #eee; border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 13px; border: 1px solid transparent; }
        .pill.active { background: #00796b; color: white; border-color: #004d40; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #00796b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .section-header { margin: 20px 0 10px 0; padding: 8px 12px; background: #00796b; color: white; border-radius: 5px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        
        .inline-input { width: 100%; padding: 5px; margin: 0; }
        .grade-badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 13px; display: inline-block; min-width: 30px; }
        .grade-star { background: #ffd700; color: #000; } /* A* */
        .grade-a { background: #c8e6c9; color: #2e7d32; } /* A */
        .grade-b { background: #fff9c4; color: #f57f17; } /* B */
        .grade-c { background: #ffe0b2; color: #ef6c00; } /* C */
        .grade-f { background: #ffcdd2; color: #c62828; } /* F */
        .perc-text { font-size: 12px; color: #666; margin-top: 2px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>üåô ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h1>

    <div class="tabs">
        <button class="tab-btn active" id="btnParent" onclick="showTab('parentView', this)">ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞</button>
        <button class="tab-btn" id="btnTeacher" onclick="showTab('teacherView', this)">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞</button>
    </div>

    <!-- ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ® -->
    <div id="parentView" class="section">
        <div class="card">
            <h3 style="margin-top:0; text-align:center;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÑﬁ¶ﬁáﬁ∞ﬁçﬁ¶ﬁàﬁß</h3>
            <input type="number" id="searchIndex" placeholder="ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß">
            <button class="btn" id="searchBtn" onclick="searchStudent()">ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÑﬁ¶ﬁçﬁß</button>
        </div>

        <div id="studentResults" style="display:none;">
            <div style="background:#00796b; color:white; padding:15px; border-radius:10px; margin-bottom:15px;">
                <h2 id="dispName" style="margin:0;"></h2>
                <p id="dispClass" style="margin:5px 0 0 0; opacity:0.8;"></p>
            </div>
            
            <div class="section-header">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Weekly Progress)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁß</th>
                            <th>ﬁÄﬁßﬁçﬁ¶ﬁåﬁ™</th>
                            <th>ﬁÇﬁØﬁìﬁ∞</th>
                        </tr>
                    </thead>
                    <tbody id="workTableBody"></tbody>
                </table>
            </div>

            <div class="section-header">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁ∞ﬁìﬁ∞ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß (Unit Test Results)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞</th>
                            <th>ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                            <th>ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ¶ﬁáﬁ∞ﬁåﬁ¶</th>
                            <th>ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞</th>
                            <th>ﬁÇﬁØﬁìﬁ∞</th>
                        </tr>
                    </thead>
                    <tbody id="testTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ® -->
    <div id="teacherView" class="section" style="display:none;">
        <div id="loginArea" class="card" style="text-align:center;">
            <h3>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</h3>
            <input type="password" id="passInput" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß">
            <button class="btn" id="loginBtn" onclick="loginTeacher()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        </div>

        <div id="teacherPanel" style="display:none;">
            <div class="sub-tabs">
                <div class="sub-tab active" id="subTabWork" onclick="switchTeacherMode('work')">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞</div>
                <div class="sub-tab" id="subTabTest" onclick="switchTeacherMode('test')">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞</div>
                <div class="sub-tab" id="subTabCA" onclick="switchTeacherMode('ca')">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁáﬁ¨ﬁêﬁ¨ﬁêﬁ∞ﬁâﬁ¨ﬁÇﬁ∞ﬁìﬁ∞</div>
            </div>

            <div class="card" style="background:#f1f8e9;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom:15px;">
                    <div style="flex: 1; min-width: 150px;">
                        <label id="bulkItemLabel" style="font-weight: bold; display: block;">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁß ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:</label>
                        <select id="bulkItemSelect" onchange="renderTeacherTable()"></select>
                    </div>
                    <div id="totalMarksArea" style="flex: 1; min-width: 120px; display: none;">
                        <label style="font-weight: bold; display: block;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞:</label>
                        <input type="number" id="totalMarksInput" value="20" oninput="renderTeacherTable()" style="margin:0;">
                    </div>
                </div>

                <div class="pills-group">
                    <div class="pills-label">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞ ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉﬁ™:</div>
                    <div id="gradeFilterButtons" class="pills"></div>
                </div>
                
                <div class="pills-group" style="border:none; padding:0;">
                    <div class="pills-label">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉﬁ™:</div>
                    <div id="classFilterButtons" class="pills"></div>
                </div>
            </div>

            <div class="table-container">
                <table id="teacherMainTable">
                    <thead>
                        <tr id="teacherTableHead">
                            <th>ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞</th>
                            <th>ﬁÇﬁ¶ﬁÇﬁ∞</th>
                            <th id="colHeaderValue">ﬁÄﬁßﬁçﬁ¶ﬁåﬁ™</th>
                            <th id="colHeaderGrade" style="display:none;">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞ / %</th>
                            <th>ﬁÇﬁØﬁìﬁ∞</th>
                        </tr>
                    </thead>
                    <tbody id="teacherTableBody"></tbody>
                </table>
            </div>
            
            <button class="btn btn-save" id="bulkSaveBtn" onclick="saveBulkData()">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0FuKBjx_6ZwkA13pmpuqGRsqe_7NXwm6IKhdynSJgslnXwUaFWxvg5tsEY5oJYVVR/exec";
    let database = [];
    let activeGradeFilter = "All";
    let activeClassFilter = "All";
    let teacherMode = "work"; 

    function getValueBySmartKey(obj, baseKey, num) {
        // baseKey is 'Week', 'Test', or 'CA'
        const keys = [
            baseKey + num,
            "Unit " + baseKey + " " + num,
            "Unit " + baseKey + num,
            baseKey + " " + num
        ];
        for (let k of keys) {
            if (obj[k] !== undefined) return obj[k];
        }
        return undefined;
    }

    function getCleanMark(val) {
        if (val === undefined || val === null || val === "") return "";
        return val.toString().trim();
    }

    function calculateGrade(mark, total) {
        const m = parseFloat(mark);
        const t = parseFloat(total) || 20;
        if (isNaN(m) || mark === "" || mark === null) return { label: "-", class: "", perc: "-" };
        const percentage = Math.round((m / t) * 100);
        
        let label = "Fail"; 
        let className = "grade-f";

        if (percentage >= 90) { 
            label = "A*"; 
            className = "grade-star"; 
        } else if (percentage >= 80) { 
            label = "A"; 
            className = "grade-a"; 
        } else if (percentage >= 70) { 
            label = "B"; 
            className = "grade-b"; 
        } else if (percentage >= 60) { 
            label = "C"; 
            className = "grade-c"; 
        }
        
        return { label: label, class: className, perc: percentage + "%" };
    }

    function setupSelects() {
        const select = document.getElementById('bulkItemSelect');
        const totalArea = document.getElementById('totalMarksArea');
        let options = "";
        
        if(teacherMode === 'work') {
            document.getElementById('bulkItemLabel').innerText = "ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁß ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:";
            for(let i=1; i<=45; i++) options += `<option value="Week${i}">Week ${i}</option>`;
            totalArea.style.display = "none";
        } else if(teacherMode === 'test') {
            document.getElementById('bulkItemLabel').innerText = "ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞:";
            for(let i=1; i<=10; i++) options += `<option value="Test${i}">Unit Test ${i}</option>`;
            totalArea.style.display = "block";
            document.getElementById('totalMarksInput').value = "20";
        } else if(teacherMode === 'ca') {
            document.getElementById('bulkItemLabel').innerText = "ﬁáﬁ¨ﬁêﬁ¨ﬁêﬁ∞ﬁâﬁ¨ﬁÇﬁ∞ﬁìﬁ∞:";
            for(let i=1; i<=4; i++) options += `<option value="CA${i}">CA ${i}</option>`;
            totalArea.style.display = "block";
            document.getElementById('totalMarksInput').value = "100";
        }
        
        select.innerHTML = options;
        updateTableHead();
    }

    function updateTableHead() {
        const headValue = document.getElementById('colHeaderValue');
        const headGrade = document.getElementById('colHeaderGrade');
        if (teacherMode === 'work') {
            headValue.innerText = "ﬁÄﬁßﬁçﬁ¶ﬁåﬁ™";
            headGrade.style.display = "none";
        } else {
            headValue.innerText = "ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞";
            headGrade.style.display = "table-cell";
        }
    }

    function showTab(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        btn.classList.add('active');
    }

    function switchTeacherMode(mode) {
        teacherMode = mode;
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        if(mode === 'work') document.getElementById('subTabWork').classList.add('active');
        else if(mode === 'test') document.getElementById('subTabTest').classList.add('active');
        else if(mode === 'ca') document.getElementById('subTabCA').classList.add('active');
        setupSelects();
        renderTeacherTable();
    }

    function loginTeacher() {
        const pass = document.getElementById('passInput').value;
        if(pass === "123") { 
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('teacherPanel').style.display = 'block';
            setupSelects();
            loadData();
        } else {
            alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®!");
        }
    }

    function fetchData(callback) {
        const cb = 'jsonp_' + Math.floor(Math.random() * 100000);
        window[cb] = (data) => {
            callback(data);
            delete window[cb];
            const sc = document.getElementById(cb + '_script');
            if(sc) sc.remove();
        };
        const script = document.createElement('script');
        script.id = cb + '_script';
        script.src = `${API_URL}?prefix=${cb}&t=${Date.now()}`;
        document.body.appendChild(script);
    }

    function loadData() {
        const body = document.getElementById('teacherTableBody');
        body.innerHTML = '<tr><td colspan="5"><span class="loader"></span> ﬁçﬁØﬁëﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...</td></tr>';
        fetchData(data => {
            database = data;
            renderFilters();
            renderTeacherTable();
        });
    }

    function renderFilters() {
        const gradeArea = document.getElementById('gradeFilterButtons');
        const classArea = document.getElementById('classFilterButtons');
        
        const grades = [...new Set(database.map(s => s.Grade))].sort((a,b) => a-b);
        let gHtml = `<div class="pill ${activeGradeFilter === 'All' ? 'active' : ''}" onclick="applyGradeFilter('All')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ¨ﬁáﬁ∞</div>`;
        grades.forEach(g => {
            if(g) gHtml += `<div class="pill ${activeGradeFilter === g.toString() ? 'active' : ''}" onclick="applyGradeFilter('${g}')">ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞ ${g}</div>`;
        });
        gradeArea.innerHTML = gHtml;

        const classes = [...new Set(database.map(s => s.Class))].filter(Boolean).sort();
        let cHtml = `<div class="pill ${activeClassFilter === 'All' ? 'active' : ''}" onclick="applyClassFilter('All')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞</div>`;
        classes.forEach(c => {
            cHtml += `<div class="pill ${activeClassFilter === c ? 'active' : ''}" onclick="applyClassFilter('${c}')">${c}</div>`;
        });
        classArea.innerHTML = cHtml;
    }

    function applyGradeFilter(f) {
        activeGradeFilter = f.toString();
        renderFilters();
        renderTeacherTable();
    }

    function applyClassFilter(f) {
        activeClassFilter = f;
        renderFilters();
        renderTeacherTable();
    }

    function updateLiveGrade(input) {
        const index = input.dataset.index;
        const mark = input.value;
        const total = document.getElementById('totalMarksInput').value;
        const res = calculateGrade(mark, total);
        const badge = document.getElementById(`grade-badge-${index}`);
        const perc = document.getElementById(`perc-text-${index}`);
        if(badge) { badge.innerText = res.label; badge.className = `grade-badge ${res.class}`; }
        if(perc) perc.innerText = res.perc;
    }

    function renderTeacherTable() {
        const body = document.getElementById('teacherTableBody');
        const selectedItem = document.getElementById('bulkItemSelect').value;
        
        let baseKey, noteKeyPrefix;
        if(teacherMode === 'work') { baseKey = 'Week'; noteKeyPrefix = 'Note'; }
        else if(teacherMode === 'test') { baseKey = 'Test'; noteKeyPrefix = 'TNote'; }
        else { baseKey = 'CA'; noteKeyPrefix = 'CANote'; }

        const itemNum = selectedItem.replace(baseKey, '');
        const totalMarks = document.getElementById('totalMarksInput').value;
        
        let filtered = database;
        if(activeGradeFilter !== "All") filtered = filtered.filter(s => s.Grade.toString() === activeGradeFilter);
        if(activeClassFilter !== "All") filtered = filtered.filter(s => s.Class === activeClassFilter);
        
        body.innerHTML = filtered.map(s => {
            const currentVal = getCleanMark(getValueBySmartKey(s, baseKey, itemNum));
            const currentNote = getValueBySmartKey(s, noteKeyPrefix, itemNum) || "";
            
            if(teacherMode === 'work') {
                return `<tr><td>${s.Index}</td><td style="text-align:right;">${s.Name}<br><small style="color:#666;">${s.Grade}${s.Class}</small></td><td><select class="inline-input" data-index="${s.Index}" data-type="val"><option value="">-</option><option value="ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®" ${currentVal === 'ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®' ? 'selected' : ''}>ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®</option><option value="ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠" ${currentVal === 'ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠' ? 'selected' : ''}>ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</option><option value="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠" ${currentVal === 'ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠' ? 'selected' : ''}>ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠</option></select></td><td><input type="text" class="inline-input" data-index="${s.Index}" data-type="note" value="${currentNote}"></td></tr>`;
            } else {
                const res = calculateGrade(currentVal, totalMarks);
                return `<tr><td>${s.Index}</td><td style="text-align:right;">${s.Name}<br><small style="color:#666;">${s.Grade}${s.Class}</small></td><td><input type="number" class="inline-input" data-index="${s.Index}" data-type="val" value="${currentVal}" oninput="updateLiveGrade(this)"></td><td><span id="grade-badge-${s.Index}" class="grade-badge ${res.class}">${res.label}</span><span id="perc-text-${s.Index}" class="perc-text">${res.perc}</span></td><td><input type="text" class="inline-input" data-index="${s.Index}" data-type="note" value="${currentNote}"></td></tr>`;
            }
        }).join('');
    }

    function searchStudent() {
        const idx = document.getElementById('searchIndex').value;
        const btn = document.getElementById('searchBtn');
        if(!idx) return;
        btn.innerHTML = '<span class="loader"></span> ﬁÄﬁØﬁãﬁ¶ﬁÇﬁ©...';
        fetchData(data => {
            btn.innerText = "ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÑﬁ¶ﬁçﬁß";
            const student = data.find(s => s.Index.toString() === idx);
            if(student) displayStudent(student);
            else { alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™!"); document.getElementById('studentResults').style.display = 'none'; }
        });
    }

    function displayStudent(s) {
        document.getElementById('dispName').innerText = s.Name;
        document.getElementById('dispClass').innerText = `ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞: ${s.Grade} ${s.Class}`;
        
        let workHtml = "";
        for(let i=1; i<=45; i++) {
            const status = getValueBySmartKey(s, 'Week', i);
            const note = getValueBySmartKey(s, 'Note', i);
            if(status) {
                let sClass = 'status-pending';
                if(status === 'ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®') sClass = 'status-done';
                else if(status === 'ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠') sClass = 'status-pending';
                else if(status === 'ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠') sClass = 'status-incomplete';
                workHtml += `<tr><td>Week ${i}</td><td><span class="status ${sClass}">${status}</span></td><td style="font-size:12px;">${note || '-'}</td></tr>`;
            }
        }
        document.getElementById('workTableBody').innerHTML = workHtml || '<tr><td colspan="3">ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ¨ﬁáﬁ∞ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</td></tr>';
        
        let testHtml = "";
        for(let i=1; i<=10; i++) {
            const mark = getCleanMark(getValueBySmartKey(s, 'Test', i));
            const note = getValueBySmartKey(s, 'TNote', i);
            if(mark !== "") {
                const res = calculateGrade(mark, 20); 
                testHtml += `<tr><td>Unit Test ${i}</td><td>${mark}</td><td>${res.perc}</td><td><span class="grade-badge ${res.class}">${res.label}</span></td><td style="font-size:12px;">${note || '-'}</td></tr>`;
            }
        }
        document.getElementById('testTableBody').innerHTML = testHtml || '<tr><td colspan="5">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ¨ﬁáﬁ∞ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</td></tr>';
        document.getElementById('studentResults').style.display = 'block';
    }

    async function saveBulkData() {
        const btn = document.getElementById('bulkSaveBtn');
        const selectedItem = document.getElementById('bulkItemSelect').value;
        const rows = document.querySelectorAll('#teacherTableBody tr');
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> ﬁêﬁ≠ﬁàﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...';

        const updates = [];
        let baseKey, noteKeyPrefix;
        if(teacherMode === 'work') { baseKey = 'Week'; noteKeyPrefix = 'Note'; }
        else if(teacherMode === 'test') { baseKey = 'Test'; noteKeyPrefix = 'TNote'; }
        else { baseKey = 'CA'; noteKeyPrefix = 'CANote'; }

        const itemNum = selectedItem.replace(baseKey, '');
        const currentNoteKey = noteKeyPrefix + itemNum;

        rows.forEach(row => {
            const valInput = row.querySelector('[data-type="val"]');
            const noteInput = row.querySelector('[data-type="note"]');
            if(!valInput) return;
            const index = valInput.dataset.index;
            const val = valInput.value;
            const note = noteInput.value;
            const sIdx = database.findIndex(s => s.Index.toString() === index);
            if(sIdx !== -1) {
                const oldVal = getCleanMark(getValueBySmartKey(database[sIdx], baseKey, itemNum));
                const oldNote = getValueBySmartKey(database[sIdx], noteKeyPrefix, itemNum) || "";
                
                if (oldVal != val || oldNote != note) {
                    updates.push({ index, val, note });
                    database[sIdx][selectedItem] = val;
                    database[sIdx][currentNoteKey] = note;
                }
            }
        });

        if (updates.length === 0) {
            alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁßﬁÇﬁ¨ ﬁáﬁ¶ﬁáﬁ™ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞.");
            btn.disabled = false; btn.innerText = "ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠";
            return;
        }

        const payload = { 
            action: 'save',
            mode: teacherMode, 
            item: selectedItem, 
            updates: JSON.stringify(updates) 
        };

        const params = new URLSearchParams(payload).toString();

        try {
            await fetch(`${API_URL}?${params}`, {
                method: 'GET',
                mode: 'no-cors'
            });
            alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨. ﬁÜﬁ™ﬁëﬁ¶ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™ﬁÜﬁÆﬁÖﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ﬁàﬁßﬁÇﬁ¨.");
            setTimeout(loadData, 2000);
        } catch (e) {
            console.error("Save Error:", e);
            alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁãﬁ®ﬁâﬁßﬁàﬁ¨ﬁáﬁ∞ﬁñﬁ¨.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠";
        }
    }
</script>

</body>
</html>
