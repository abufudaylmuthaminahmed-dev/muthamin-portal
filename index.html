<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</title>
    <style>
        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('https://fonts.cdnfonts.com/s/73114/Faruma.woff') format('woff'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'), url('https://fonts.cdnfonts.com/s/73114/MV_Waheed.woff') format('woff'); }
        
        * { font-family: "Faruma", sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: #f3f4f6; margin: 0; padding: 10px; text-align: right; color: #333; }
        
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 90vh; }
        
        h1 { color: #00897b; text-align: center; font-family: "MV Waheed"; margin-bottom: 25px; font-size: 1.8rem; }
        
        /* Modern Tabs */
        .tabs { display: flex; background: #e0f2f1; padding: 5px; border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 16px; color: #00695c; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: #fff; color: #004d40; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Login Card */
        .login-card { text-align: center; padding: 40px 20px; background: #fafafa; border-radius: 12px; border: 1px dashed #ccc; }
        .login-input { padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; width: 200px; text-align: center; margin-bottom: 10px; }

        /* Controls Area */
        .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 12px; }
        .control-row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; background: white; flex: 1; }
        
        /* Pills for Mode Selection */
        .mode-pills { display: flex; gap: 5px; background: #fff; padding: 5px; border-radius: 25px; border: 1px solid #eee; display: inline-flex; }
        .mode-btn { padding: 8px 15px; border: none; background: none; cursor: pointer; border-radius: 20px; font-size: 13px; }
        .mode-btn.active { background: #00897b; color: white; }

        /* Table Styling */
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 10px; background: white; max-height: 65vh; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #00897b; color: white; padding: 12px; position: sticky; top: 0; z-index: 10; font-size: 14px; }
        td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle; }
        tr:nth-child(even) { background-color: #fafafa; }
        
        /* Inputs in Table */
        .v-input { width: 100%; padding: 8px; border: 2px solid #b2dfdb; border-radius: 6px; text-align: center; font-weight: bold; font-size: 15px; }
        .v-input:focus { border-color: #00897b; outline: none; background: #e0f2f1; }
        .n-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }

        /* Grade Badges */
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; color: white; display: inline-block; min-width: 30px; }
        .bg-A-star { background: #ffd700; color: #333; }
        .bg-A { background: #43a047; }
        .bg-B { background: #1e88e5; }
        .bg-C { background: #fb8c00; }
        .bg-F { background: #e53935; }

        /* Save Button */
        .fab-save { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #2e7d32; color: white; padding: 12px 30px; 
            border-radius: 30px; border: none; font-size: 16px; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 100;
            display: flex; align-items: center; gap: 10px;
        }
        .fab-save:disabled { background: #9e9e9e; cursor: wait; }

        .loader { border: 3px solid #fff; border-top: 3px solid rgba(255,255,255,0.3); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader-dark { border: 3px solid #00897b; border-top: 3px solid transparent; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Student Card */
        .st-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .st-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .st-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üåô ﬁáﬁ®ﬁêﬁ∞ﬁçﬁßﬁâﬁ∞ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('parent')">ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞</button>
        <button class="tab-btn" onclick="switchTab('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞</button>
    </div>

    <!-- PARENT VIEW -->
    <div id="viewParent">
        <div style="text-align: center; margin-bottom: 20px;">
            <input type="number" id="stIdx" placeholder="ﬁáﬁ®ﬁÇﬁ∞ﬁëﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™" class="login-input" style="width: 100%; max-width: 300px;">
            <button onclick="findStudent()" style="padding: 12px 25px; background: #00897b; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ﬁÑﬁ¶ﬁçﬁßﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞</button>
        </div>
        <div id="parentResults"></div>
    </div>

    <!-- TEACHER VIEW -->
    <div id="viewTeacher" style="display: none;">
        <div id="loginSection" class="login-card">
            <h3>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</h3>
            <input type="password" id="tPass" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
            <br>
            <button onclick="teacherLogin()" style="padding: 10px 30px; background: #00897b; color: white; border: none; border-radius: 5px; cursor: pointer;">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="controls">
                <div class="control-row">
                    <div class="mode-pills">
                        <button class="mode-btn active" onclick="setMode('week')" id="btn-week">ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁß</button>
                        <button class="mode-btn" onclick="setMode('unit')" id="btn-unit">ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞</button>
                        <button class="mode-btn" onclick="setMode('ca')" id="btn-ca">CA</button>
                    </div>
                    <button onclick="refreshData()" style="background:none; border:none; color:#00695c; cursor:pointer;">üîÑ Refresh</button>
                </div>
                
                <div class="control-row">
                    <select id="itemSelect" onchange="renderTable()"></select>
                    <select id="gradeFilter" onchange="renderTable()" style="max-width: 100px;">
                        <option value="All">All Grd</option>
                    </select>
                </div>

                <div id="totalMarksDiv" style="display:none; text-align:left;">
                    <small>Out of:</small> <input type="number" id="totalMarks" value="20" style="width:60px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:5px;" oninput="renderTable()">
                </div>
            </div>

            <div id="loadingMsg" style="text-align:center; padding:20px; display:none;">
                <div class="loader loader-dark"></div> ﬁçﬁØﬁëﬁ∞ﬁàﬁ¶ﬁÇﬁ©...
            </div>

            <div class="table-container">
                <table id="teacherTable">
                    <thead>
                        <tr>
                            <th style="width:60px">Index</th>
                            <th>Name</th>
                            <th id="thVal">Status/Marks</th>
                            <th id="thGrade" style="width:60px; display:none;">%</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <button id="saveBtn" class="fab-save" onclick="saveChanges()">
                <span>üíæ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span>
            </button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwtH5H6xdj5-7x1X1xWBbIQrFXsxHN0E4GvFKtS43raYqD6ga7JJLrx-Y5Ja5I2EVO4/exec";
    
    let db = [];
    let currentMode = 'week';
    let dataCache = {};

    function switchTab(tab) {
        document.getElementById('viewParent').style.display = tab === 'parent' ? 'block' : 'none';
        document.getElementById('viewTeacher').style.display = tab === 'teacher' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', (tab === 'parent' ? i === 0 : i === 1)));
    }

    function teacherLogin() {
        if(document.getElementById('tPass').value === "123") {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            refreshData();
        } else alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®!");
    }

    // ﬁëﬁ≠ﬁìﬁß ﬁäﬁ¨ﬁóﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (JSONP) - Always unique timestamp to avoid cache
    function refreshData() {
        document.getElementById('loadingMsg').style.display = 'block';
        document.getElementById('tableBody').innerHTML = '';
        
        // Random number to force bypass cache
        const uniqueId = Date.now() + "_" + Math.floor(Math.random() * 1000);
        const cb = 'cb_' + uniqueId;
        
        window[cb] = (data) => {
            db = data;
            populateFilters();
            setMode(currentMode); // Re-render
            document.getElementById('loadingMsg').style.display = 'none';
            delete window[cb];
            const s = document.getElementById('script_' + uniqueId);
            if(s) s.remove();
        };
        
        const script = document.createElement('script');
        script.id = 'script_' + uniqueId;
        // Added t parameter with unique timestamp
        script.src = `${API_URL}?prefix=${cb}&action=read&t=${uniqueId}`;
        document.body.appendChild(script);
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');

        // Populate Items Dropdown
        const select = document.getElementById('itemSelect');
        let html = '';
        if(mode === 'week') {
            for(let i=1; i<=45; i++) html += `<option value="Week${i}">Week ${i}</option>`;
            document.getElementById('totalMarksDiv').style.display = 'none';
            document.getElementById('thVal').innerText = "Status";
            document.getElementById('thGrade').style.display = "none";
        } else if(mode === 'unit') {
            for(let i=1; i<=10; i++) html += `<option value="Unit Test ${i}">Unit Test ${i}</option>`;
            document.getElementById('totalMarksDiv').style.display = 'block';
            document.getElementById('thVal').innerText = "Marks";
            document.getElementById('thGrade').style.display = "table-cell";
        } else {
            for(let i=1; i<=4; i++) html += `<option value="CA${i}">CA ${i}</option>`;
            document.getElementById('totalMarksDiv').style.display = 'block';
            document.getElementById('thVal').innerText = "Marks";
            document.getElementById('thGrade').style.display = "table-cell";
        }
        select.innerHTML = html;
        renderTable();
    }

    function populateFilters() {
        if(!db.length) return;
        const grades = [...new Set(db.map(s => s.Grade))].filter(Boolean).sort();
        let html = '<option value="All">All Grades</option>';
        grades.forEach(g => html += `<option value="${g}">${g}</option>`);
        document.getElementById('gradeFilter').innerHTML = html;
    }

    // ﬁëﬁ≠ﬁìﬁß ﬁÄﬁØﬁãﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÄﬁ©ﬁàﬁ¨ﬁãﬁ≠ ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ (Normalization)
    function findVal(student, key) {
        // 1. Try exact match
        if (student[key] !== undefined) return student[key];
        
        // 2. Try lowercase no space match (e.g. 'Week 1' -> 'week1')
        let simpleKey = key.toLowerCase().replace(/\s+/g, '');
        let keys = Object.keys(student);
        for(let k of keys) {
            if(k.toLowerCase().replace(/\s+/g, '') === simpleKey) return student[k];
        }
        return "";
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const item = document.getElementById('itemSelect').value;
        const gradeFilter = document.getElementById('gradeFilter').value;
        const total = document.getElementById('totalMarks').value || 100;
        
        // Determine Note Key
        let num = item.match(/\d+/)[0];
        let noteKey = currentMode === 'week' ? 'Note'+num : (currentMode === 'unit' ? 'TNote'+num : 'CANote'+num);

        let filtered = db.filter(s => gradeFilter === 'All' || s.Grade == gradeFilter);
        
        if(!filtered.length) {
            tbody.innerHTML = '<tr><td colspan="5">No data</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(s => {
            let val = findVal(s, item); // Using helper to find value
            let note = findVal(s, noteKey);
            
            let inputField;
            let gradeDisplay = '';

            if(currentMode === 'week') {
                inputField = `
                    <select class="v-in" data-idx="${s.Index}">
                        <option value="">-</option>
                        <option value="ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®" ${val === 'ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®' ? 'selected' : ''}>ﬁÇﬁ®ﬁâﬁ®ﬁäﬁ¶ﬁáﬁ®</option>
                        <option value="ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠" ${val === 'ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠' ? 'selected' : ''}>ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</option>
                        <option value="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠" ${val === 'ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠' ? 'selected' : ''}>ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ≠</option>
                    </select>`;
            } else {
                inputField = `<input type="number" class="v-in" data-idx="${s.Index}" value="${val}" oninput="calcRow(this, ${total})">`;
                let g = calcGrade(val, total);
                gradeDisplay = val ? `<span class="badge ${g.cls}">${g.lbl}</span>` : '';
            }

            return `<tr>
                <td>${s.Index}</td>
                <td style="text-align:right">${s.Name} <br><small style="color:#888">${s.Grade} ${s.Class}</small></td>
                <td>${inputField}</td>
                ${currentMode !== 'week' ? `<td id="g-${s.Index}">${gradeDisplay}</td>` : ''}
                <td><input type="text" class="n-in" value="${note}" placeholder="..."></td>
            </tr>`;
        }).join('');
    }

    function calcGrade(m, t) {
        if(!m || isNaN(m)) return { lbl:'', cls:'' };
        let p = (m/t)*100;
        if(p>=90) return {lbl:'A*', cls:'bg-A-star'};
        if(p>=80) return {lbl:'A', cls:'bg-A'};
        if(p>=70) return {lbl:'B', cls:'bg-B'};
        if(p>=60) return {lbl:'C', cls:'bg-C'};
        return {lbl:'Fail', cls:'bg-F'};
    }

    function calcRow(el, t) {
        let g = calcGrade(el.value, t);
        document.getElementById('g-'+el.dataset.idx).innerHTML = `<span class="badge ${g.cls}">${g.lbl}</span>`;
    }

    function saveChanges() {
        const btn = document.getElementById('saveBtn');
        const item = document.getElementById('itemSelect').value;
        const total = document.getElementById('totalMarks').value;
        
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> ﬁêﬁ≠ﬁàﬁ∞ ﬁàﬁ¶ﬁÇﬁ©...';

        const inputs = document.querySelectorAll('.v-in');
        const notes = document.querySelectorAll('.n-in');
        let updates = [];

        inputs.forEach((inp, i) => {
            updates.push({
                index: inp.dataset.idx,
                val: inp.value,
                note: notes[i].value
            });
        });

        const payload = {
            action: 'save',
            item: item,
            mode: currentMode,
            updates: JSON.stringify(updates)
        };
        
        const params = new URLSearchParams(payload);

        // Fetch with no-cors to post data and force cache bypass
        fetch(`${API_URL}?${params}&t=${Date.now()}`, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        }).then(() => {
            setTimeout(() => {
                alert("ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁàﬁ¨ﬁáﬁ∞ﬁñﬁ¨!");
                btn.disabled = false;
                btn.innerHTML = "<span>üíæ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span>";
                refreshData(); // Force reload to see changes
            }, 1500);
        }).catch(e => {
            alert("ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁãﬁ®ﬁâﬁßﬁàﬁ¨ﬁáﬁ∞ﬁñﬁ¨");
            btn.disabled = false;
        });
    }

    function searchStudent() {
        const idx = document.getElementById('stIdx').value;
        if(!idx) return;
        document.getElementById('parentResults').innerHTML = '<div style="text-align:center"><div class="loader loader-dark"></div></div>';

        const uniqueId = Date.now() + "_" + Math.floor(Math.random() * 1000);
        const cb = 'find_' + uniqueId;
        
        window[cb] = (data) => {
            const s = data.find(x => String(x.Index) === String(idx));
            if(s) {
                let html = `<div class="st-card"><div class="st-header"><div><h2>${s.Name}</h2><small>${s.Grade} ${s.Class}</small></div><h1>${s.Index}</h1></div>`;
                
                // Show Weeks
                html += `<h4>ﬁÄﬁ¶ﬁäﬁ∞ﬁåﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞</h4>`;
                for(let i=1; i<=45; i++) {
                    let v = findVal(s, 'Week'+i);
                    let n = findVal(s, 'Note'+i);
                    if(v) html += `<div class="st-row"><span>Week ${i}</span><span><b>${v}</b> <br><small style="color:#666">${n}</small></span></div>`;
                }

                // Show Tests
                html += `<h4>ﬁîﬁ™ﬁÇﬁ®ﬁìﬁ∞ ﬁìﬁ¨ﬁêﬁ∞ﬁìﬁ∞</h4>`;
                for(let i=1; i<=10; i++) {
                    let v = findVal(s, 'Unit Test '+i);
                    let n = findVal(s, 'TNote'+i); // Note for test
                    if(v) html += `<div class="st-row"><span>Test ${i}</span><span><b>${v}</b> <br><small style="color:#666">${n}</small></span></div>`;
                }

                document.getElementById('parentResults').innerHTML = html;
            } else {
                document.getElementById('parentResults').innerHTML = "<p style='text-align:center; color:red'>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™</p>";
            }
            delete window[cb];
            const sEl = document.getElementById('script_' + uniqueId);
            if(sEl) sEl.remove();
        };
        const script = document.createElement('script');
        script.id = 'script_' + uniqueId;
        script.src = `${API_URL}?prefix=${cb}&action=read&t=${uniqueId}`;
        document.body.appendChild(script);
    }
</script>

</body>
</html>
